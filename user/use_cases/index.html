
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentación para el desarrollador backend del proyecto AgroInSight">
      
      
      
      
        <link rel="prev" href="../schemas/">
      
      
        <link rel="next" href="../repository/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Casos de uso - AgroInsight Backend Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#casos-de-uso-de-usuario" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="AgroInsight Backend Documentation" class="md-header__button md-logo" aria-label="AgroInsight Backend Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AgroInsight Backend Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Casos de uso
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="AgroInsight Backend Documentation" class="md-nav__button md-logo" aria-label="AgroInsight Backend Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AgroInsight Backend Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Documentación complementaria
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Documentación complementaria
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../complement-docs/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Descripción
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://agroinsight-backend-production.up.railway.app/docs" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FastAPI Swagger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://agroinsight-backend-production.up.railway.app/redoc" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ReDoc
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://dbdocs.io/davidvalencia0526/AgroInsight" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Base de datos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.figma.com/design/PwBFnVysZISNgO8UIoOHL1/Agroinsight?node-id=0-1&node-type=CANVAS&t=s9L7qvi4CEiMX9ad-0" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Diseño de interfaz UI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/DavidValenciaX/agroinsight-backend" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositorio backend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/Alejandroo04/AgroInsight_Front" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositorio frontend
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://usco-team-y6acsy2v.atlassian.net/jira/software/projects/AGROINSHT/boards/1/backlog" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Jira
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://drive.google.com/drive/folders/1Nt50sTun-_FQMulYEXsy5aUcIJ7TXKpZ" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sharepoint
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://join.slack.com/t/agroinsight/shared_invite/zt-2rnhell7b-3~ziopW1zaod0ZD8QP6QFw" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Slack
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guías
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Guías
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Instalación
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting_started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guía de inicio rápido
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preguntas frecuentes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Módulo de usuarios
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Módulo de usuarios
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Descripción
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelos de datos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../schemas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Esquemas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Casos de uso
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Casos de uso
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#proceso-de-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Creación de Usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Creación de Usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Creación de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      UserRegisterUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_pending_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_pending_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.is_confirmation_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_confirmation_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
    <nav class="md-nav" aria-label="send_confirmation_email">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de creación de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de creación de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="register_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
    <nav class="md-nav" aria-label="send_confirmation_email">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-confirmacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Confirmación de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ConfirmationUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.activate_user" class="md-nav__link">
    <span class="md-ellipsis">
      activate_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_active_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_active_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.increment_confirmation_attempts" class="md-nav__link">
    <span class="md-ellipsis">
      increment_confirmation_attempts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.is_confirmation_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_confirmation_expired
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_confirmation_expired">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-confirmacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de confirmación de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de confirmación de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="confirm_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-confirmacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de Confirmación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResendConfirmationUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-confirmacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de confirmación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de confirmación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proceso-de-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Inicio de Sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Inicio de Sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Inicio de Sesión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      LoginUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.handle_failed_login_attempt" class="md-nav__link">
    <span class="md-ellipsis">
      handle_failed_login_attempt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.send_two_factor_verification_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_two_factor_verification_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de inicio de sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de inicio de sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="login_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-verificacion-de-autenticacion-de-dos-factores" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Verificación de Autenticación de Dos Factores
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      VerifyUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.increment_two_factor_attempts" class="md-nav__link">
    <span class="md-ellipsis">
      increment_two_factor_attempts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_two_factor_verification_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_two_factor_verification_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
    <nav class="md-nav" aria-label="verify_2fa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-verificacion-de-autenticacion-de-dos-factores" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de verificación de autenticación de dos factores
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de verificación de autenticación de dos factores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
    <nav class="md-nav" aria-label="verify_2fa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-pin-de-verificacion-en-dos-pasos" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de PIN de Verificación en Dos Pasos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      Resend2faUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.send_two_factor_pin" class="md-nav__link">
    <span class="md-ellipsis">
      send_two_factor_pin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-pin-de-verificacion-en-dos-pasos" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de PIN de verificación en dos pasos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de PIN de verificación en dos pasos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proceso-de-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Recuperación de Contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Recuperación de Contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Recuperación de Contraseña
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      PasswordRecoveryUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.send_password_recovery_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_password_recovery_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de recuperación de contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de recuperación de contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
    <nav class="md-nav" aria-label="recovery_password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-confirmacion-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Confirmación de PIN de Recuperación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ConfirmRecoveryPinUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_password_recovery_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_password_recovery_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_user_blocked">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-confirmacion-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de confirmación de PIN de recuperación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de confirmación de PIN de recuperación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="confirm_recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de PIN de Recuperación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResendRecoveryUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.send_password_recovery_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_password_recovery_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de PIN de recuperación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de PIN de recuperación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="resend_recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-restablecimiento-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Restablecimiento de Contraseña
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResetPasswordUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
    <nav class="md-nav" aria-label="reset_password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-restablecimiento-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de restablecimiento de contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de restablecimiento de contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#otros-casos-de-uso" class="md-nav__link">
    <span class="md-ellipsis">
      Otros Casos de Uso
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Otros Casos de Uso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-cierre-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Cierre de Sesión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      LogoutUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.blacklist_token" class="md-nav__link">
    <span class="md-ellipsis">
      blacklist_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="logout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-cierre-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de cierre de sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de cierre de sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="logout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-obtener-usuario-actual" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Obtener Usuario Actual
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      GetCurrentUserUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_current_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-obtener-usuario-actual" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de obtener usuario actual
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de obtener usuario actual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_current_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-actualizar-informacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Actualizar Información de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      UpdateUserInfoUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_user_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-actualizacion-de-informacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de actualización de información de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de actualización de información de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../repository/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Repositorio
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Módulo de Fincas
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Módulo de Fincas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../farm/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Descripción
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../farm/endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../farm/models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelos de datos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../farm/use_cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Casos de uso
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Módulo de lotes
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Módulo de lotes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Descripción
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelos de datos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../plot/use_cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Casos de uso
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Módulo de labores culturales
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Módulo de labores culturales
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cultural_practices/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Descripción
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cultural_practices/endpoints/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endpoints
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cultural_practices/models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Modelos de datos
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cultural_practices/use_cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Casos de uso
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Desarrollo
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Desarrollo
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/contributing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Guía para contribuir al proyecto
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../development/coding_standards/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Estándares de codificación
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acerca de
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#proceso-de-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Creación de Usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Creación de Usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Creación de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      UserRegisterUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_pending_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_pending_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.is_confirmation_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_confirmation_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
    <nav class="md-nav" aria-label="send_confirmation_email">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-creacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de creación de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de creación de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user" class="md-nav__link">
    <span class="md-ellipsis">
      register_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="register_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_confirmation_email
    </span>
  </a>
  
    <nav class="md-nav" aria-label="send_confirmation_email">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-confirmacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Confirmación de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ConfirmationUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.activate_user" class="md-nav__link">
    <span class="md-ellipsis">
      activate_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_active_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_active_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.increment_confirmation_attempts" class="md-nav__link">
    <span class="md-ellipsis">
      increment_confirmation_attempts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.is_confirmation_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_confirmation_expired
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_confirmation_expired">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-confirmacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de confirmación de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de confirmación de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="confirm_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-confirmacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de Confirmación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResendConfirmationUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.get_last_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation_email" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-confirmacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de confirmación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de confirmación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation" class="md-nav__link">
    <span class="md-ellipsis">
      resend_confirmation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proceso-de-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Inicio de Sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Inicio de Sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Inicio de Sesión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      LoginUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.handle_failed_login_attempt" class="md-nav__link">
    <span class="md-ellipsis">
      handle_failed_login_attempt
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.send_two_factor_verification_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_two_factor_verification_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-inicio-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de inicio de sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de inicio de sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.login_use_case.LoginUseCase.login_user" class="md-nav__link">
    <span class="md-ellipsis">
      login_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="login_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-verificacion-de-autenticacion-de-dos-factores" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Verificación de Autenticación de Dos Factores
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      VerifyUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.increment_two_factor_attempts" class="md-nav__link">
    <span class="md-ellipsis">
      increment_two_factor_attempts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_two_factor_verification_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_two_factor_verification_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
    <nav class="md-nav" aria-label="verify_2fa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-verificacion-de-autenticacion-de-dos-factores" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de verificación de autenticación de dos factores
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de verificación de autenticación de dos factores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      verify_2fa
    </span>
  </a>
  
    <nav class="md-nav" aria-label="verify_2fa">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-pin-de-verificacion-en-dos-pasos" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de PIN de Verificación en Dos Pasos
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      Resend2faUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.get_last_verification" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_verification
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.send_two_factor_pin" class="md-nav__link">
    <span class="md-ellipsis">
      send_two_factor_pin
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-pin-de-verificacion-en-dos-pasos" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de PIN de verificación en dos pasos
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de PIN de verificación en dos pasos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa" class="md-nav__link">
    <span class="md-ellipsis">
      resend_2fa
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#proceso-de-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Proceso de Recuperación de Contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proceso de Recuperación de Contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Recuperación de Contraseña
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      PasswordRecoveryUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.send_password_recovery_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_password_recovery_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-recuperacion-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de recuperación de contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de recuperación de contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password" class="md-nav__link">
    <span class="md-ellipsis">
      recovery_password
    </span>
  </a>
  
    <nav class="md-nav" aria-label="recovery_password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-confirmacion-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Confirmación de PIN de Recuperación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ConfirmRecoveryPinUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.block_user" class="md-nav__link">
    <span class="md-ellipsis">
      block_user
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_locked_user_state" class="md-nav__link">
    <span class="md-ellipsis">
      get_locked_user_state
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_password_recovery_expired" class="md-nav__link">
    <span class="md-ellipsis">
      is_password_recovery_expired
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_user_blocked" class="md-nav__link">
    <span class="md-ellipsis">
      is_user_blocked
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_user_blocked">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-confirmacion-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de confirmación de PIN de recuperación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de confirmación de PIN de recuperación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      confirm_recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="confirm_recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-reenvio-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Reenvío de PIN de Recuperación
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResendRecoveryUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.send_password_recovery_email" class="md-nav__link">
    <span class="md-ellipsis">
      send_password_recovery_email
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.was_recently_requested" class="md-nav__link">
    <span class="md-ellipsis">
      was_recently_requested
    </span>
  </a>
  
    <nav class="md-nav" aria-label="was_recently_requested">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-reenvio-de-pin-de-recuperacion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de reenvío de PIN de recuperación
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de reenvío de PIN de recuperación">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      resend_recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="resend_recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-restablecimiento-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Restablecimiento de Contraseña
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      ResetPasswordUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.get_last_password_recovery" class="md-nav__link">
    <span class="md-ellipsis">
      get_last_password_recovery
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
    <nav class="md-nav" aria-label="reset_password">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-restablecimiento-de-contrasena" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de restablecimiento de contraseña
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de restablecimiento de contraseña">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password" class="md-nav__link">
    <span class="md-ellipsis">
      reset_password
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#otros-casos-de-uso" class="md-nav__link">
    <span class="md-ellipsis">
      Otros Casos de Uso
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Otros Casos de Uso">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-cierre-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Cierre de Sesión
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      LogoutUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.blacklist_token" class="md-nav__link">
    <span class="md-ellipsis">
      blacklist_token
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="logout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-cierre-de-sesion" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de cierre de sesión
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de cierre de sesión">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.logout_use_case.LogoutUseCase.logout" class="md-nav__link">
    <span class="md-ellipsis">
      logout
    </span>
  </a>
  
    <nav class="md-nav" aria-label="logout">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-obtener-usuario-actual" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Obtener Usuario Actual
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      GetCurrentUserUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_current_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-obtener-usuario-actual" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de obtener usuario actual
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de obtener usuario actual">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_current_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#caso-de-uso-actualizar-informacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Caso de Uso: Actualizar Información de Usuario
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase" class="md-nav__link">
    <span class="md-ellipsis">
      UpdateUserInfoUseCase
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
    <nav class="md-nav" aria-label="update_user_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#metodos-principales-de-actualizacion-de-informacion-de-usuario" class="md-nav__link">
    <span class="md-ellipsis">
      Métodos Principales de actualización de información de usuario
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Métodos Principales de actualización de información de usuario">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info" class="md-nav__link">
    <span class="md-ellipsis">
      update_user_info
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="casos-de-uso-de-usuario">Casos de Uso de Usuario</h1>
<p>Este documento describe los casos de uso relacionados con la gestión de usuarios en el sistema AgroInsight.</p>
<h2 id="proceso-de-creacion-de-usuario">Proceso de Creación de Usuario</h2>
<h3 id="caso-de-uso-creacion-de-usuario">Caso de Uso: Creación de Usuario</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para la creación de un nuevo usuario en el sistema.</p>
<p>Esta clase maneja la lógica de negocio para el registro de nuevos usuarios,
incluyendo la validación de datos, la creación del usuario en la base de datos,
y el envío de correos de confirmación.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos para realizar operaciones.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones de usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador de estados de usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UserRegisterUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para la creación de un nuevo usuario en el sistema.</span>

<span class="sd">    Esta clase maneja la lógica de negocio para el registro de nuevos usuarios,</span>
<span class="sd">    incluyendo la validación de datos, la creación del usuario en la base de datos,</span>
<span class="sd">    y el envío de correos de confirmación.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): La sesión de base de datos para realizar operaciones.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones de usuario.</span>
<span class="sd">        state_validator (UserStateValidator): Validador de estados de usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de UserRegisterUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Crea un nuevo usuario en el sistema.</span>

<span class="sd">        Este método realiza las siguientes operaciones:</span>
<span class="sd">        1. Verifica si el usuario ya existe.</span>
<span class="sd">        2. Verifica si la confirmación del usuario ha expirado.</span>
<span class="sd">        3. Valida el estado del usuario si no tiene confirmación expirada.</span>
<span class="sd">        4. Crea un nuevo usuario con estado pendiente.</span>
<span class="sd">        5. Crea y envía una confirmación por correo electrónico.</span>

<span class="sd">        Args:</span>
<span class="sd">            user_data (UserCreate): Datos del usuario a crear.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si ocurre un error durante el proceso de creación.</span>
<span class="sd">            UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">confirmations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
            <span class="n">expired_confirmation</span> <span class="o">=</span> <span class="n">confirmations</span> <span class="k">if</span> <span class="n">confirmations</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmations</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">expired_confirmation</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
                    <span class="n">user</span><span class="p">,</span>
                    <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="c1"># Obtener estado &quot;pendiente&quot; del usuario (caché o consulta única)</span>
        <span class="n">pending_state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pending_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_state_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario pendiente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Hash del password</span>
        <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

        <span class="c1"># Crear nuevo usuario</span>
        <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">nombre</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
            <span class="n">apellido</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">apellido</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">hashed_password</span><span class="p">,</span>
            <span class="n">state_id</span><span class="o">=</span><span class="n">pending_state_id</span>
        <span class="p">)</span>
        <span class="n">created_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

        <span class="c1"># Generar PIN y su hash</span>
        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
        <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

        <span class="n">confirmation</span> <span class="o">=</span> <span class="n">UserConfirmation</span><span class="p">(</span>
            <span class="n">usuario_id</span><span class="o">=</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
            <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
            <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al agregar la confirmación del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="c1"># Enviar correo de confirmación de manera asíncrona</span>
        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_confirmation_email</span><span class="p">,</span> <span class="n">created_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario creado. Por favor, revisa tu email para confirmar el registro.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico de confirmación al usuario.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">            pin (str): PIN de confirmación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Confirma tu registro en AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;p&gt;&lt;strong&gt;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">                &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">send_email_sendpulse</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_confirmation_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la confirmación del usuario ha expirado.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la confirmación ha expirado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
            <span class="c1"># Ordenar las confirmaciones por fecha de creación de forma ascendente</span>
            <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="c1"># Tomar el último registro</span>
            <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Eliminar todas las confirmaciones anteriores a la última</span>
            <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
            <span class="c1"># Actualizar la variable confirmation para solo trabajar con la última</span>
            <span class="k">return</span> <span class="n">latest_confirmation</span>
        <span class="c1"># Si no hay confirmaciones, retornar None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_pending_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene el estado &#39;pendiente&#39; del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserStateModel]: El estado &#39;pendiente&#39; del usuario.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserStateException: Si no se puede encontrar el estado &#39;pendiente&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pending_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">PENDING_STATE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario pendiente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">pending_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de UserRegisterUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos a utilizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de UserRegisterUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_last_confirmation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última confirmación del usuario y elimina las anteriores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de confirmaciones del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="c1"># Ordenar las confirmaciones por fecha de creación de forma ascendente</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="c1"># Tomar el último registro</span>
        <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Eliminar todas las confirmaciones anteriores a la última</span>
        <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
        <span class="c1"># Actualizar la variable confirmation para solo trabajar con la última</span>
        <span class="k">return</span> <span class="n">latest_confirmation</span>
    <span class="c1"># Si no hay confirmaciones, retornar None</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.get_pending_user_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_pending_user_state</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene el estado 'pendiente' del usuario.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserState" href="../models/#app.user.infrastructure.orm_models.UserState">UserState</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserStateModel]: El estado 'pendiente' del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se puede encontrar el estado 'pendiente'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_pending_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado &#39;pendiente&#39; del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserStateModel]: El estado &#39;pendiente&#39; del usuario.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserStateException: Si no se puede encontrar el estado &#39;pendiente&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pending_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">PENDING_STATE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">pending_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.is_confirmation_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la confirmación del usuario ha expirado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de confirmación del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la confirmación ha expirado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_confirmation_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la confirmación del usuario ha expirado.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la confirmación ha expirado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">register_user</span><span class="p">(</span><span class="n">user_data</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Crea un nuevo usuario en el sistema.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica si el usuario ya existe.
2. Verifica si la confirmación del usuario ha expirado.
3. Valida el estado del usuario si no tiene confirmación expirada.
4. Crea un nuevo usuario con estado pendiente.
5. Crea y envía una confirmación por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user_data</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserCreate" href="../schemas/#app.user.domain.schemas.UserCreate">UserCreate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datos del usuario a crear.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de creación.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es válido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crea un nuevo usuario en el sistema.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica si el usuario ya existe.</span>
<span class="sd">    2. Verifica si la confirmación del usuario ha expirado.</span>
<span class="sd">    3. Valida el estado del usuario si no tiene confirmación expirada.</span>
<span class="sd">    4. Crea un nuevo usuario con estado pendiente.</span>
<span class="sd">    5. Crea y envía una confirmación por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        user_data (UserCreate): Datos del usuario a crear.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de creación.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">confirmations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
        <span class="n">expired_confirmation</span> <span class="o">=</span> <span class="n">confirmations</span> <span class="k">if</span> <span class="n">confirmations</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmations</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">expired_confirmation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
                <span class="n">user</span><span class="p">,</span>
                <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Obtener estado &quot;pendiente&quot; del usuario (caché o consulta única)</span>
    <span class="n">pending_state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pending_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_state_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Hash del password</span>
    <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># Crear nuevo usuario</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">nombre</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
        <span class="n">apellido</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">apellido</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">hashed_password</span><span class="p">,</span>
        <span class="n">state_id</span><span class="o">=</span><span class="n">pending_state_id</span>
    <span class="p">)</span>
    <span class="n">created_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

    <span class="c1"># Generar PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">confirmation</span> <span class="o">=</span> <span class="n">UserConfirmation</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al agregar la confirmación del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="c1"># Enviar correo de confirmación de manera asíncrona</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_confirmation_email</span><span class="p">,</span> <span class="n">created_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario creado. Por favor, revisa tu email para confirmar el registro.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_confirmation_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico de confirmación al usuario.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de confirmación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió correctamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico de confirmación al usuario.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de confirmación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Confirma tu registro en AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">            &lt;p&gt;&lt;strong&gt;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_email_sendpulse</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja la lógica de negocio para el registro de nuevos usuarios, incluyendo la validación de datos, la creación del usuario en la base de datos, y el envío de correos de confirmación.</p>
<h4 id="metodos-principales-de-creacion-de-usuario">Métodos Principales de creación de usuario</h4>
<h5 id="register_user">register_user</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.register_user"></a>
    <div class="doc doc-contents first">

        <p>Crea un nuevo usuario en el sistema.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica si el usuario ya existe.
2. Verifica si la confirmación del usuario ha expirado.
3. Valida el estado del usuario si no tiene confirmación expirada.
4. Crea un nuevo usuario con estado pendiente.
5. Crea y envía una confirmación por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user_data</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserCreate" href="../schemas/#app.user.domain.schemas.UserCreate">UserCreate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datos del usuario a crear.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de creación.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es válido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">register_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_data</span><span class="p">:</span> <span class="n">UserCreate</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crea un nuevo usuario en el sistema.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica si el usuario ya existe.</span>
<span class="sd">    2. Verifica si la confirmación del usuario ha expirado.</span>
<span class="sd">    3. Valida el estado del usuario si no tiene confirmación expirada.</span>
<span class="sd">    4. Crea un nuevo usuario con estado pendiente.</span>
<span class="sd">    5. Crea y envía una confirmación por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        user_data (UserCreate): Datos del usuario a crear.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de creación.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">confirmations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
        <span class="n">expired_confirmation</span> <span class="o">=</span> <span class="n">confirmations</span> <span class="k">if</span> <span class="n">confirmations</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmations</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">expired_confirmation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
                <span class="n">user</span><span class="p">,</span>
                <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Obtener estado &quot;pendiente&quot; del usuario (caché o consulta única)</span>
    <span class="n">pending_state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pending_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pending_state_id</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Hash del password</span>
    <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">user_data</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># Crear nuevo usuario</span>
    <span class="n">new_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
        <span class="n">nombre</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">nombre</span><span class="p">,</span>
        <span class="n">apellido</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">apellido</span><span class="p">,</span>
        <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">hashed_password</span><span class="p">,</span>
        <span class="n">state_id</span><span class="o">=</span><span class="n">pending_state_id</span>
    <span class="p">)</span>
    <span class="n">created_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user</span><span class="p">(</span><span class="n">new_user</span><span class="p">)</span>

    <span class="c1"># Generar PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">confirmation</span> <span class="o">=</span> <span class="n">UserConfirmation</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">created_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al agregar la confirmación del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="c1"># Enviar correo de confirmación de manera asíncrona</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_confirmation_email</span><span class="p">,</span> <span class="n">created_user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario creado. Por favor, revisa tu email para confirmar el registro.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h5 id="send_confirmation_email">send_confirmation_email</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.user_register_process.user_register_use_case.UserRegisterUseCase.send_confirmation_email"></a>
    <div class="doc doc-contents first">

        <p>Envía un correo electrónico de confirmación al usuario.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de confirmación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió correctamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\user_register_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico de confirmación al usuario.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de confirmación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Confirma tu registro en AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">            &lt;p&gt;&lt;strong&gt;Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_email_sendpulse</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-confirmacion-de-usuario">Caso de Uso: Confirmación de Usuario</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para la confirmación del registro de un usuario en el sistema.</p>
<p>Esta clase maneja la lógica de negocio para confirmar el registro de usuarios,
incluyendo la validación del PIN, la activación del usuario y la gestión de intentos fallidos.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos para realizar operaciones.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones de usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador de estados de usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ConfirmationUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para la confirmación del registro de un usuario en el sistema.</span>

<span class="sd">    Esta clase maneja la lógica de negocio para confirmar el registro de usuarios,</span>
<span class="sd">    incluyendo la validación del PIN, la activación del usuario y la gestión de intentos fallidos.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): La sesión de base de datos para realizar operaciones.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones de usuario.</span>
<span class="sd">        state_validator (UserStateValidator): Validador de estados de usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de ConfirmationUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">confirm_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confirma el registro de un usuario mediante un PIN.</span>

<span class="sd">        Este método realiza las siguientes operaciones:</span>
<span class="sd">        1. Obtiene el usuario por correo electrónico.</span>
<span class="sd">        2. Valida el estado del usuario.</span>
<span class="sd">        3. Verifica la existencia de una confirmación pendiente.</span>
<span class="sd">        4. Comprueba si la confirmación ha expirado.</span>
<span class="sd">        5. Verifica el PIN proporcionado.</span>
<span class="sd">        6. Activa el usuario si el PIN es correcto.</span>
<span class="sd">        7. Elimina el registro de confirmación.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            pin (str): PIN de confirmación proporcionado por el usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si ocurre un error durante el proceso de confirmación.</span>
<span class="sd">            UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Obtener el usuario por correo electrónico</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="c1"># Validar el estado del usuario</span>
        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="c1"># Verificar si hay una confirmación pendiente</span>
        <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de confirmación para este usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="c1"># Verificar si la confirmación está expirada</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
            <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La confirmación ha expirado. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="c1"># Hashear el PIN proporcionado</span>
        <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

        <span class="c1"># Obtener el registro de confirmación</span>
        <span class="n">confirm_pin</span> <span class="o">=</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm_pin</span><span class="p">:</span>
            <span class="c1"># Manejar intentos fallidos de confirmación</span>
            <span class="n">intentos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_confirmation_attempts</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Demasiados intentos. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación incorrecto.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">activate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># Eliminar el registro de confirmación</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario confirmado exitosamente.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_confirmation_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la confirmación ha expirado.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la confirmación ha expirado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">increment_confirmation_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Incrementa los intentos de confirmación.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: El número actualizado de intentos de confirmación.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span>

    <span class="k">def</span> <span class="nf">activate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Activa el usuario cambiando su estado a activo.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): Objeto de usuario a activar.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserStateException: Si no se puede encontrar el estado de usuario activo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_user_state</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario activo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="n">active_state</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
            <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_confirmation</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">get_active_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene el estado activo del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserStateModel]: El estado activo del usuario.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserStateException: Si no se puede encontrar el estado de usuario activo.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">ACTIVE_STATE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">active_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario activo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">active_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de ConfirmationUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos a utilizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de ConfirmationUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.activate_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">activate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Activa el usuario cambiando su estado a activo.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de usuario a activar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se puede encontrar el estado de usuario activo.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">activate_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Activa el usuario cambiando su estado a activo.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): Objeto de usuario a activar.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserStateException: Si no se puede encontrar el estado de usuario activo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_active_user_state</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario activo.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>
    <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="n">active_state</span><span class="o">.</span><span class="n">id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">confirm_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Confirma el registro de un usuario mediante un PIN.</p>
<p>Este método realiza las siguientes operaciones:
1. Obtiene el usuario por correo electrónico.
2. Valida el estado del usuario.
3. Verifica la existencia de una confirmación pendiente.
4. Comprueba si la confirmación ha expirado.
5. Verifica el PIN proporcionado.
6. Activa el usuario si el PIN es correcto.
7. Elimina el registro de confirmación.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de confirmación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de confirmación.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es válido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">confirm_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Confirma el registro de un usuario mediante un PIN.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Obtiene el usuario por correo electrónico.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Verifica la existencia de una confirmación pendiente.</span>
<span class="sd">    4. Comprueba si la confirmación ha expirado.</span>
<span class="sd">    5. Verifica el PIN proporcionado.</span>
<span class="sd">    6. Activa el usuario si el PIN es correcto.</span>
<span class="sd">    7. Elimina el registro de confirmación.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de confirmación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de confirmación.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener el usuario por correo electrónico</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Verificar si hay una confirmación pendiente</span>
    <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de confirmación para este usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="c1"># Verificar si la confirmación está expirada</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La confirmación ha expirado. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="c1"># Hashear el PIN proporcionado</span>
    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

    <span class="c1"># Obtener el registro de confirmación</span>
    <span class="n">confirm_pin</span> <span class="o">=</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm_pin</span><span class="p">:</span>
        <span class="c1"># Manejar intentos fallidos de confirmación</span>
        <span class="n">intentos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_confirmation_attempts</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Demasiados intentos. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">activate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Eliminar el registro de confirmación</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario confirmado exitosamente.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_active_user_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_active_user_state</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene el estado activo del usuario.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserState" href="../models/#app.user.infrastructure.orm_models.UserState">UserState</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserStateModel]: El estado activo del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se puede encontrar el estado de usuario activo.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_active_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado activo del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserStateModel]: El estado activo del usuario.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserStateException: Si no se puede encontrar el estado de usuario activo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">ACTIVE_STATE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo encontrar el estado de usuario activo.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">active_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.get_last_confirmation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última confirmación del usuario y elimina las anteriores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de confirmaciones del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_confirmation</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.increment_confirmation_attempts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">increment_confirmation_attempts</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Incrementa los intentos de confirmación.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de confirmación del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El número actualizado de intentos de confirmación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">increment_confirmation_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Incrementa los intentos de confirmación.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: El número actualizado de intentos de confirmación.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.is_confirmation_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la confirmación ha expirado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de confirmación del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la confirmación ha expirado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_confirmation_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la confirmación ha expirado.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la confirmación ha expirado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja la lógica de negocio para confirmar el registro de usuarios mediante un PIN, incluyendo la validación del PIN, la activación del usuario y la gestión de intentos fallidos.</p>
<h4 id="metodos-principales-de-confirmacion-de-usuario">Métodos Principales de confirmación de usuario</h4>
<h5 id="confirm_user">confirm_user</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.user_register_process.confirmation_use_case.ConfirmationUseCase.confirm_user"></a>
    <div class="doc doc-contents first">

        <p>Confirma el registro de un usuario mediante un PIN.</p>
<p>Este método realiza las siguientes operaciones:
1. Obtiene el usuario por correo electrónico.
2. Valida el estado del usuario.
3. Verifica la existencia de una confirmación pendiente.
4. Comprueba si la confirmación ha expirado.
5. Verifica el PIN proporcionado.
6. Activa el usuario si el PIN es correcto.
7. Elimina el registro de confirmación.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de confirmación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de confirmación.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es válido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">confirm_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Confirma el registro de un usuario mediante un PIN.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Obtiene el usuario por correo electrónico.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Verifica la existencia de una confirmación pendiente.</span>
<span class="sd">    4. Comprueba si la confirmación ha expirado.</span>
<span class="sd">    5. Verifica el PIN proporcionado.</span>
<span class="sd">    6. Activa el usuario si el PIN es correcto.</span>
<span class="sd">    7. Elimina el registro de confirmación.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de confirmación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de confirmación.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es válido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Obtener el usuario por correo electrónico</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Verificar si hay una confirmación pendiente</span>
    <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de confirmación para este usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="c1"># Verificar si la confirmación está expirada</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_confirmation_expired</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La confirmación ha expirado. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="c1"># Hashear el PIN proporcionado</span>
    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

    <span class="c1"># Obtener el registro de confirmación</span>
    <span class="n">confirm_pin</span> <span class="o">=</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirm_pin</span><span class="p">:</span>
        <span class="c1"># Manejar intentos fallidos de confirmación</span>
        <span class="n">intentos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_confirmation_attempts</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Eliminar usuario y con el se elimina su confirmación</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Demasiados intentos. Por favor, inicie el proceso de registro nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">activate_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Eliminar el registro de confirmación</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario confirmado exitosamente.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-reenvio-de-confirmacion">Caso de Uso: Reenvío de Confirmación</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para reenviar la confirmación de registro a un usuario.</p>
<p>Esta clase maneja la lógica de negocio para reenviar PINs de confirmación,
incluyendo la validación del estado del usuario, la generación de nuevos PINs,
y el envío de correos electrónicos de confirmación.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos para realizar operaciones.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones de usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador de estados de usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResendConfirmationUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para reenviar la confirmación de registro a un usuario.</span>

<span class="sd">    Esta clase maneja la lógica de negocio para reenviar PINs de confirmación,</span>
<span class="sd">    incluyendo la validación del estado del usuario, la generación de nuevos PINs,</span>
<span class="sd">    y el envío de correos electrónicos de confirmación.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): La sesión de base de datos para realizar operaciones.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones de usuario.</span>
<span class="sd">        state_validator (UserStateValidator): Validador de estados de usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de ResendConfirmationUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resend_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reenvía la confirmación de registro a un usuario.</span>

<span class="sd">        Este método realiza las siguientes operaciones:</span>
<span class="sd">        1. Verifica si el usuario existe.</span>
<span class="sd">        2. Valida el estado del usuario.</span>
<span class="sd">        3. Obtiene la última confirmación del usuario.</span>
<span class="sd">        4. Verifica si se puede reenviar la confirmación (tiempo de espera).</span>
<span class="sd">        5. Genera un nuevo PIN y actualiza la confirmación.</span>
<span class="sd">        6. Envía un nuevo correo electrónico con el PIN.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si ocurre un error durante el proceso de reenvío.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="c1"># Validar el estado del usuario</span>
        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="c1"># Obtener confirmación del usuario</span>
        <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>

        <span class="c1"># Verificar si hay una confirmación pendiente</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una confirmación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="c1"># Definimos el tiempo de espera en minutos</span>
        <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># Si es el primer reenvío (resends == 0), permitir sin restricción</span>
        <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Si ya ha reenviado al menos una vez, verificar si han pasado 3 minutos</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
                <span class="p">)</span>

        <span class="c1"># Generar nuevo PIN y su hash</span>
        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
        <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

        <span class="c1"># Actualizar el registro de confirmación de usuario con manejo de errores</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
            <span class="c1"># Log the error or handle it as needed</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al actualizar la confirmación del usuario&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="c1"># Enviar el correo electrónico con el nuevo PIN</span>
        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resend_confirmation_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación reenviado con éxito.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">resend_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico con el PIN de confirmación reenviado.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">            pin (str): Nuevo PIN de confirmación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Confirma tu registro en AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">                &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la confirmación se solicitó recientemente.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>
<span class="sd">            minutes (int, optional): Número de minutos para considerar como reciente. Por defecto es 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la confirmación se solicitó hace menos de los minutos especificados, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">confirmation</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">        Args:</span>
<span class="sd">            confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
            <span class="c1"># Ordenar las confirmaciones por fecha de creación de forma ascendente</span>
            <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="c1"># Tomar el último registro</span>
            <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Eliminar todas las confirmaciones anteriores a la última</span>
            <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
            <span class="c1"># Actualizar la variable confirmation para solo trabajar con la última</span>
            <span class="k">return</span> <span class="n">latest_confirmation</span>
        <span class="c1"># Si no hay confirmaciones, retornar None</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de ResendConfirmationUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos a utilizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de ResendConfirmationUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.get_last_confirmation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última confirmación del usuario y elimina las anteriores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de confirmaciones del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserConfirmation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última confirmación del usuario y elimina las anteriores.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Lista de confirmaciones del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserConfirmation]: La última confirmación del usuario o None si no hay confirmaciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="c1"># Ordenar las confirmaciones por fecha de creación de forma ascendente</span>
        <span class="n">confirmation</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="c1"># Tomar el último registro</span>
        <span class="n">latest_confirmation</span> <span class="o">=</span> <span class="n">confirmation</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Eliminar todas las confirmaciones anteriores a la última</span>
        <span class="k">for</span> <span class="n">old_confirmation</span> <span class="ow">in</span> <span class="n">confirmation</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_user_confirmation</span><span class="p">(</span><span class="n">old_confirmation</span><span class="p">)</span>
        <span class="c1"># Actualizar la variable confirmation para solo trabajar con la última</span>
        <span class="k">return</span> <span class="n">latest_confirmation</span>
    <span class="c1"># Si no hay confirmaciones, retornar None</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resend_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reenvía la confirmación de registro a un usuario.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica si el usuario existe.
2. Valida el estado del usuario.
3. Obtiene la última confirmación del usuario.
4. Verifica si se puede reenviar la confirmación (tiempo de espera).
5. Genera un nuevo PIN y actualiza la confirmación.
6. Envía un nuevo correo electrónico con el PIN.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de reenvío.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía la confirmación de registro a un usuario.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica si el usuario existe.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Obtiene la última confirmación del usuario.</span>
<span class="sd">    4. Verifica si se puede reenviar la confirmación (tiempo de espera).</span>
<span class="sd">    5. Genera un nuevo PIN y actualiza la confirmación.</span>
<span class="sd">    6. Envía un nuevo correo electrónico con el PIN.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de reenvío.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Obtener confirmación del usuario</span>
    <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>

    <span class="c1"># Verificar si hay una confirmación pendiente</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una confirmación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="c1"># Definimos el tiempo de espera en minutos</span>
    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># Si es el primer reenvío (resends == 0), permitir sin restricción</span>
    <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Si ya ha reenviado al menos una vez, verificar si han pasado 3 minutos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="c1"># Generar nuevo PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="c1"># Actualizar el registro de confirmación de usuario con manejo de errores</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="c1"># Log the error or handle it as needed</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al actualizar la confirmación del usuario&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="c1"># Enviar el correo electrónico con el nuevo PIN</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resend_confirmation_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación reenviado con éxito.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation_email" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resend_confirmation_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico con el PIN de confirmación reenviado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nuevo PIN de confirmación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió correctamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_confirmation_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico con el PIN de confirmación reenviado.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">        pin (str): Nuevo PIN de confirmación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Confirma tu registro en AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">            &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de confirmación es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.was_recently_requested" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la confirmación se solicitó recientemente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>confirmation</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserConfirmation" href="../models/#app.user.infrastructure.orm_models.UserConfirmation">UserConfirmation</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de confirmación del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>minutes</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de minutos para considerar como reciente. Por defecto es 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la confirmación se solicitó hace menos de los minutos especificados, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">confirmation</span><span class="p">:</span> <span class="n">UserConfirmation</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la confirmación se solicitó recientemente.</span>

<span class="sd">    Args:</span>
<span class="sd">        confirmation (UserConfirmation): Objeto de confirmación del usuario.</span>
<span class="sd">        minutes (int, optional): Número de minutos para considerar como reciente. Por defecto es 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la confirmación se solicitó hace menos de los minutos especificados, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">confirmation</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja la lógica de negocio para reenviar PINs de confirmación a usuarios que están en proceso de registro.</p>
<h4 id="metodos-principales-de-reenvio-de-confirmacion">Métodos Principales de reenvío de confirmación</h4>
<h5 id="resend_confirmation">resend_confirmation</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.user_register_process.resend_confirmation_use_case.ResendConfirmationUseCase.resend_confirmation"></a>
    <div class="doc doc-contents first">

        <p>Reenvía la confirmación de registro a un usuario.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica si el usuario existe.
2. Valida el estado del usuario.
3. Obtiene la última confirmación del usuario.
4. Verifica si se puede reenviar la confirmación (tiempo de espera).
5. Genera un nuevo PIN y actualiza la confirmación.
6. Envía un nuevo correo electrónico con el PIN.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito de la operación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de reenvío.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\user_register_process\resend_confirmation_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía la confirmación de registro a un usuario.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica si el usuario existe.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Obtiene la última confirmación del usuario.</span>
<span class="sd">    4. Verifica si se puede reenviar la confirmación (tiempo de espera).</span>
<span class="sd">    5. Genera un nuevo PIN y actualiza la confirmación.</span>
<span class="sd">    6. Envía un nuevo correo electrónico con el PIN.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito de la operación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de reenvío.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_confirmation</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Obtener confirmación del usuario</span>
    <span class="n">confirmation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_confirmation</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">confirmacion</span><span class="p">)</span>

    <span class="c1"># Verificar si hay una confirmación pendiente</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">confirmation</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una confirmación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="c1"># Definimos el tiempo de espera en minutos</span>
    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># Si es el primer reenvío (resends == 0), permitir sin restricción</span>
    <span class="k">if</span> <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Si ya ha reenviado al menos una vez, verificar si han pasado 3 minutos</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">confirmation</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="c1"># Generar nuevo PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="c1"># Actualizar el registro de confirmación de usuario con manejo de errores</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">confirmation</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user_confirmation</span><span class="p">(</span><span class="n">confirmation</span><span class="p">):</span>
        <span class="c1"># Log the error or handle it as needed</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error al actualizar la confirmación del usuario&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="c1"># Enviar el correo electrónico con el nuevo PIN</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resend_confirmation_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de confirmación reenviado con éxito.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="proceso-de-inicio-de-sesion">Proceso de Inicio de Sesión</h2>
<h3 id="caso-de-uso-inicio-de-sesion">Caso de Uso: Inicio de Sesión</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.login_process.login_use_case.LoginUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para el proceso de inicio de sesión.</p>
<p>Esta clase maneja la lógica de negocio para el inicio de sesión de usuarios,
incluyendo la validación de credenciales, el manejo de intentos fallidos,
y la generación de PIN para autenticación de dos factores.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.login_use_case.LoginUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos para realizar operaciones.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.login_use_case.LoginUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones de usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.login_use_case.LoginUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador de estados de usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LoginUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para el proceso de inicio de sesión.</span>

<span class="sd">    Esta clase maneja la lógica de negocio para el inicio de sesión de usuarios,</span>
<span class="sd">    incluyendo la validación de credenciales, el manejo de intentos fallidos,</span>
<span class="sd">    y la generación de PIN para autenticación de dos factores.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): La sesión de base de datos para realizar operaciones.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones de usuario.</span>
<span class="sd">        state_validator (UserStateValidator): Validador de estados de usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de LoginUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">login_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicia el proceso de inicio de sesión para un usuario.</span>

<span class="sd">        Este método realiza las siguientes operaciones:</span>
<span class="sd">        1. Verifica la existencia del usuario.</span>
<span class="sd">        2. Valida el estado del usuario.</span>
<span class="sd">        3. Verifica la contraseña.</span>
<span class="sd">        4. Maneja intentos fallidos de inicio de sesión.</span>
<span class="sd">        5. Genera y envía un PIN para autenticación de dos factores.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            password (str): Contraseña del usuario.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando el éxito del inicio del proceso de autenticación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si ocurre un error durante el proceso de inicio de sesión.</span>
<span class="sd">            UserHasBeenBlockedException: Si el usuario ha sido bloqueado por múltiples intentos fallidos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="c1"># Validar el estado del usuario</span>
        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="c1"># Verificar si verification trajo una lista de varias verificaciones,</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>

        <span class="c1"># Verificar si ya se ha enviado un PIN en los ltimos 3 minutos</span>
        <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">verification</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
                <span class="p">)</span>

            <span class="c1"># Eliminar verificaciones de dos pasos expiradas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handle_failed_login_attempt</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># Autenticación exitosa</span>
        <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="c1"># Generar el PIN y su hash</span>
        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
        <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

        <span class="c1"># Crear un nuevo registro de verificación</span>
        <span class="n">verification</span> <span class="o">=</span> <span class="n">TwoStepVerification</span><span class="p">(</span>
            <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
            <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
            <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

        <span class="c1"># Enviar el PIN al correo electrónico del usuario</span>
        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_verification_email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Verificación en dos pasos iniciada. Por favor, revisa tu correo electrónico para obtener el PIN.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_failed_login_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maneja un intento fallido de inicio de sesión.</span>

<span class="sd">        Incrementa el contador de intentos fallidos y bloquea al usuario si se excede el límite.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): El usuario que ha fallado en el intento de inicio de sesión.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserHasBeenBlockedException: Si el usuario es bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">            DomainException: Si la contraseña es incorrecta pero no se ha alcanzado el límite de intentos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_failed_attempts</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">&gt;=</span> <span class="n">max_failed_attempts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Contraseña incorrecta.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_two_factor_verification_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico con el PIN de verificación en dos pasos.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">            pin (str): PIN de verificación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;PIN de verificación en dos pasos - AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;&lt;strong&gt;Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>

        <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la verificación de dos pasos se solicitó recientemente.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto de verificación de dos pasos.</span>
<span class="sd">            minutes (int, optional): Número de minutos para considerar como reciente. Por defecto es 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la verificación se solicitó hace menos de los minutos especificados, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verifica si la verificación de dos pasos se solicitó hace menos de x minutos.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última verificación de dos pasos si existe.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Lista de verificaciones de dos pasos.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[TwoStepVerification]: La última verificación de dos pasos o None si no hay verificaciones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtiene la última verificación de dos pasos si existe.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
            <span class="c1"># Ordenar las verificaciones por fecha de creación de forma ascendente</span>
            <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="c1"># Tomar el último registro</span>
            <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Eliminar todas las verificaciones anteriores a la última</span>
            <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
            <span class="c1"># Actualizar la variable verification para solo trabajar con la última</span>
            <span class="k">return</span> <span class="n">latest_verification</span>
        <span class="c1"># Si no hay verificaciones, retornar None</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si un usuario está bloqueado.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): El usuario a verificar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bloquea a un usuario por un período de tiempo específico.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): El usuario a bloquear.</span>
<span class="sd">            lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si ocurre un error al bloquear al usuario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
            <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="c1"># Verificación adicional</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene el estado de usuario &#39;bloqueado&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserStateModel]: El estado de usuario &#39;bloqueado&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se puede obtener el estado de usuario bloqueado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de LoginUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos a utilizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de LoginUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.block_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Bloquea a un usuario por un período de tiempo específico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El usuario a bloquear.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lock_duration</code></td>
            <td>
                  <code><span title="datetime.timedelta">timedelta</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Duración del bloqueo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario fue bloqueado exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error al bloquear al usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bloquea a un usuario por un período de tiempo específico.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): El usuario a bloquear.</span>
<span class="sd">        lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si ocurre un error al bloquear al usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
        <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="c1"># Verificación adicional</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.get_last_verification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última verificación de dos pasos si existe.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lista de verificaciones de dos pasos.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[TwoStepVerification]: La última verificación de dos pasos o None si no hay verificaciones.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última verificación de dos pasos si existe.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Lista de verificaciones de dos pasos.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[TwoStepVerification]: La última verificación de dos pasos o None si no hay verificaciones.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtiene la última verificación de dos pasos si existe.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
        <span class="c1"># Ordenar las verificaciones por fecha de creación de forma ascendente</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="c1"># Tomar el último registro</span>
        <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># Eliminar todas las verificaciones anteriores a la última</span>
        <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
        <span class="c1"># Actualizar la variable verification para solo trabajar con la última</span>
        <span class="k">return</span> <span class="n">latest_verification</span>
    <span class="c1"># Si no hay verificaciones, retornar None</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.get_locked_user_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_locked_user_state</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene el estado de usuario 'bloqueado'.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserState" href="../models/#app.user.infrastructure.orm_models.UserState">UserState</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserStateModel]: El estado de usuario 'bloqueado'.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se puede obtener el estado de usuario bloqueado.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado de usuario &#39;bloqueado&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserStateModel]: El estado de usuario &#39;bloqueado&#39;.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se puede obtener el estado de usuario bloqueado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.handle_failed_login_attempt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_failed_login_attempt</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Maneja un intento fallido de inicio de sesión.</p>
<p>Incrementa el contador de intentos fallidos y bloquea al usuario si se excede el límite.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El usuario que ha fallado en el intento de inicio de sesión.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario es bloqueado debido a múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si la contraseña es incorrecta pero no se ha alcanzado el límite de intentos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">handle_failed_login_attempt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maneja un intento fallido de inicio de sesión.</span>

<span class="sd">    Incrementa el contador de intentos fallidos y bloquea al usuario si se excede el límite.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): El usuario que ha fallado en el intento de inicio de sesión.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario es bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">        DomainException: Si la contraseña es incorrecta pero no se ha alcanzado el límite de intentos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_failed_attempts</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">&gt;=</span> <span class="n">max_failed_attempts</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Contraseña incorrecta.&quot;</span><span class="p">,</span>
        <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.is_user_blocked" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si un usuario está bloqueado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El usuario a verificar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario está bloqueado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si un usuario está bloqueado.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): El usuario a verificar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.login_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">login_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicia el proceso de inicio de sesión para un usuario.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica la existencia del usuario.
2. Valida el estado del usuario.
3. Verifica la contraseña.
4. Maneja intentos fallidos de inicio de sesión.
5. Genera y envía un PIN para autenticación de dos factores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>password</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contraseña del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito del inicio del proceso de autenticación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de inicio de sesión.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado por múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">login_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicia el proceso de inicio de sesión para un usuario.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica la existencia del usuario.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Verifica la contraseña.</span>
<span class="sd">    4. Maneja intentos fallidos de inicio de sesión.</span>
<span class="sd">    5. Genera y envía un PIN para autenticación de dos factores.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        password (str): Contraseña del usuario.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito del inicio del proceso de autenticación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de inicio de sesión.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado por múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Verificar si verification trajo una lista de varias verificaciones,</span>
    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>

    <span class="c1"># Verificar si ya se ha enviado un PIN en los ltimos 3 minutos</span>
    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

        <span class="c1"># Eliminar verificaciones de dos pasos expiradas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_failed_login_attempt</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Autenticación exitosa</span>
    <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Generar el PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="c1"># Crear un nuevo registro de verificación</span>
    <span class="n">verification</span> <span class="o">=</span> <span class="n">TwoStepVerification</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="c1"># Enviar el PIN al correo electrónico del usuario</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_verification_email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Verificación en dos pasos iniciada. Por favor, revisa tu correo electrónico para obtener el PIN.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.send_two_factor_verification_email" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_two_factor_verification_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico con el PIN de verificación en dos pasos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de verificación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió correctamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_two_factor_verification_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico con el PIN de verificación en dos pasos.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de verificación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió correctamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;PIN de verificación en dos pasos - AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;&lt;strong&gt;Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>

    <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.login_use_case.LoginUseCase.was_recently_requested" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la verificación de dos pasos se solicitó recientemente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de verificación de dos pasos.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>minutes</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de minutos para considerar como reciente. Por defecto es 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la verificación se solicitó hace menos de los minutos especificados, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la verificación de dos pasos se solicitó recientemente.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto de verificación de dos pasos.</span>
<span class="sd">        minutes (int, optional): Número de minutos para considerar como reciente. Por defecto es 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la verificación se solicitó hace menos de los minutos especificados, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verifica si la verificación de dos pasos se solicitó hace menos de x minutos.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja la lógica de negocio para el inicio de sesión de usuarios, incluyendo la validación de credenciales, el manejo de intentos fallidos, y la generación de PIN para autenticación de dos factores.</p>
<h4 id="metodos-principales-de-inicio-de-sesion">Métodos Principales de inicio de sesión</h4>
<h5 id="login_user">login_user</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.login_process.login_use_case.LoginUseCase.login_user"></a>
    <div class="doc doc-contents first">

        <p>Inicia el proceso de inicio de sesión para un usuario.</p>
<p>Este método realiza las siguientes operaciones:
1. Verifica la existencia del usuario.
2. Valida el estado del usuario.
3. Verifica la contraseña.
4. Maneja intentos fallidos de inicio de sesión.
5. Genera y envía un PIN para autenticación de dos factores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>password</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contraseña del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando el éxito del inicio del proceso de autenticación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si ocurre un error durante el proceso de inicio de sesión.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado por múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\login_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">login_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicia el proceso de inicio de sesión para un usuario.</span>

<span class="sd">    Este método realiza las siguientes operaciones:</span>
<span class="sd">    1. Verifica la existencia del usuario.</span>
<span class="sd">    2. Valida el estado del usuario.</span>
<span class="sd">    3. Verifica la contraseña.</span>
<span class="sd">    4. Maneja intentos fallidos de inicio de sesión.</span>
<span class="sd">    5. Genera y envía un PIN para autenticación de dos factores.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        password (str): Contraseña del usuario.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando el éxito del inicio del proceso de autenticación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si ocurre un error durante el proceso de inicio de sesión.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado por múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="c1"># Validar el estado del usuario</span>
    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="c1"># Verificar si verification trajo una lista de varias verificaciones,</span>
    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>

    <span class="c1"># Verificar si ya se ha enviado un PIN en los ltimos 3 minutos</span>
    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

        <span class="c1"># Eliminar verificaciones de dos pasos expiradas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_failed_login_attempt</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Autenticación exitosa</span>
    <span class="n">user</span><span class="o">.</span><span class="n">failed_attempts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c1"># Generar el PIN y su hash</span>
    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="c1"># Crear un nuevo registro de verificación</span>
    <span class="n">verification</span> <span class="o">=</span> <span class="n">TwoStepVerification</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="c1"># Enviar el PIN al correo electrónico del usuario</span>
    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_verification_email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Verificación en dos pasos iniciada. Por favor, revisa tu correo electrónico para obtener el PIN.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-verificacion-de-autenticacion-de-dos-factores">Caso de Uso: Verificación de Autenticación de Dos Factores</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para verificar la autenticación de dos factores.</p>
<p>Esta clase maneja el proceso de verificación del PIN de autenticación de dos factores,
incluyendo la validación del estado del usuario, la verificación del PIN,
y el manejo de intentos fallidos.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">VerifyUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para verificar la autenticación de dos factores.</span>

<span class="sd">    Esta clase maneja el proceso de verificación del PIN de autenticación de dos factores,</span>
<span class="sd">    incluyendo la validación del estado del usuario, la verificación del PIN,</span>
<span class="sd">    y el manejo de intentos fallidos.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de VerifyUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">verify_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica el PIN de autenticación de dos factores.</span>

<span class="sd">        Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">        de verificación de dos factores válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">        los intentos fallidos.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            pin (str): PIN de verificación proporcionado por el usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TokenResponse: Respuesta con el token de acceso si la verificación es exitosa.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si no hay una verificación pendiente, el PIN ha expirado,</span>
<span class="sd">                             el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">            UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_two_factor_verification_expired</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La verificación ha expirado. Por favor, inicie el proceso de doble factor de autenticación nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="n">verify_pin</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_pin</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_two_factor_attempts</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación incorrecto.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

        <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
            <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
            <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">increment_two_factor_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Incrementa el contador de intentos fallidos de verificación de dos factores.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto de verificación de dos factores.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Número actualizado de intentos fallidos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span>

    <span class="k">def</span> <span class="nf">is_two_factor_verification_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la verificación de dos factores ha expirado.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto de verificación de dos factores.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la verificación ha expirado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">verification</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última verificación de dos factores del usuario.</span>

<span class="sd">        Esta función también elimina todas las verificaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto o lista de objetos de verificación de dos factores.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[TwoStepVerification]: La última verificación de dos factores, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
            <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_verification</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si el usuario está bloqueado.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): Objeto de usuario a verificar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bloquea al usuario por un período de tiempo específico.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): Usuario a bloquear.</span>
<span class="sd">            lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se pudo bloquear al usuario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
            <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene el estado de usuario bloqueado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se pudo obtener el estado de usuario bloqueado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de VerifyUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de VerifyUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.block_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Bloquea al usuario por un período de tiempo específico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usuario a bloquear.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lock_duration</code></td>
            <td>
                  <code><span title="datetime.timedelta">timedelta</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Duración del bloqueo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario fue bloqueado exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo bloquear al usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bloquea al usuario por un período de tiempo específico.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): Usuario a bloquear.</span>
<span class="sd">        lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo bloquear al usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
        <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_last_verification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última verificación de dos factores del usuario.</p>
<p>Esta función también elimina todas las verificaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de verificación de dos factores.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[TwoStepVerification]: La última verificación de dos factores, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última verificación de dos factores del usuario.</span>

<span class="sd">    Esta función también elimina todas las verificaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto o lista de objetos de verificación de dos factores.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[TwoStepVerification]: La última verificación de dos factores, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_verification</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.get_locked_user_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_locked_user_state</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene el estado de usuario bloqueado.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserState" href="../models/#app.user.infrastructure.orm_models.UserState">UserState</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo obtener el estado de usuario bloqueado.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado de usuario bloqueado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo obtener el estado de usuario bloqueado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.increment_two_factor_attempts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">increment_two_factor_attempts</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Incrementa el contador de intentos fallidos de verificación de dos factores.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de verificación de dos factores.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número actualizado de intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">increment_two_factor_attempts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Incrementa el contador de intentos fallidos de verificación de dos factores.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto de verificación de dos factores.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: Número actualizado de intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_two_factor_verification_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_two_factor_verification_expired</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la verificación de dos factores ha expirado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de verificación de dos factores.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la verificación ha expirado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_two_factor_verification_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la verificación de dos factores ha expirado.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto de verificación de dos factores.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la verificación ha expirado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">verification</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.is_user_blocked" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si el usuario está bloqueado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de usuario a verificar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario está bloqueado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si el usuario está bloqueado.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): Objeto de usuario a verificar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">verify_2fa</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica el PIN de autenticación de dos factores.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de verificación de dos factores válida, comprueba el PIN proporcionado y maneja
los intentos fallidos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de verificación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>TokenResponse</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.TokenResponse" href="../schemas/#app.user.domain.schemas.TokenResponse">TokenResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta con el token de acceso si la verificación es exitosa.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una verificación pendiente, el PIN ha expirado,
             el PIN es incorrecto, o hay otros errores.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">verify_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica el PIN de autenticación de dos factores.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de verificación de dos factores válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">    los intentos fallidos.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de verificación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        TokenResponse: Respuesta con el token de acceso si la verificación es exitosa.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una verificación pendiente, el PIN ha expirado,</span>
<span class="sd">                         el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_two_factor_verification_expired</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La verificación ha expirado. Por favor, inicie el proceso de doble factor de autenticación nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
    <span class="n">verify_pin</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_pin</span><span class="p">:</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_two_factor_attempts</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de verificación del PIN de autenticación de dos factores, incluyendo la validación del estado del usuario, la verificación del PIN, y el manejo de intentos fallidos.</p>
<h4 id="metodos-principales-de-verificacion-de-autenticacion-de-dos-factores">Métodos Principales de verificación de autenticación de dos factores</h4>
<h5 id="verify_2fa">verify_2fa</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.login_process.verify_2fa_use_case.VerifyUseCase.verify_2fa"></a>
    <div class="doc doc-contents first">

        <p>Verifica el PIN de autenticación de dos factores.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de verificación de dos factores válida, comprueba el PIN proporcionado y maneja
los intentos fallidos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de verificación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>TokenResponse</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.TokenResponse" href="../schemas/#app.user.domain.schemas.TokenResponse">TokenResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta con el token de acceso si la verificación es exitosa.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una verificación pendiente, el PIN ha expirado,
             el PIN es incorrecto, o hay otros errores.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\verify_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">verify_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica el PIN de autenticación de dos factores.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de verificación de dos factores válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">    los intentos fallidos.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de verificación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        TokenResponse: Respuesta con el token de acceso si la verificación es exitosa.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una verificación pendiente, el PIN ha expirado,</span>
<span class="sd">                         el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_two_factor_verification_expired</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La verificación ha expirado. Por favor, inicie el proceso de doble factor de autenticación nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
    <span class="n">verify_pin</span> <span class="o">=</span> <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">verify_pin</span><span class="p">:</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increment_two_factor_attempts</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attempts</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span>

    <span class="n">access_token</span> <span class="o">=</span> <span class="n">create_access_token</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;sub&quot;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">TokenResponse</span><span class="p">(</span>
        <span class="n">access_token</span><span class="o">=</span><span class="n">access_token</span><span class="p">,</span>
        <span class="n">token_type</span><span class="o">=</span><span class="s2">&quot;bearer&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-reenvio-de-pin-de-verificacion-en-dos-pasos">Caso de Uso: Reenvío de PIN de Verificación en Dos Pasos</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para reenviar el PIN de verificación en dos pasos.</p>
<p>Esta clase maneja el proceso de reenvío del PIN de verificación en dos pasos,
incluyendo la validación del estado del usuario, la verificación de solicitudes
recientes, y la generación y envío de un nuevo PIN.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Resend2faUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para reenviar el PIN de verificación en dos pasos.</span>

<span class="sd">    Esta clase maneja el proceso de reenvío del PIN de verificación en dos pasos,</span>
<span class="sd">    incluyendo la validación del estado del usuario, la verificación de solicitudes</span>
<span class="sd">    recientes, y la generación y envío de un nuevo PIN.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de Resend2faUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resend_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reenvía el PIN de verificación en dos pasos.</span>

<span class="sd">        Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">        un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que se ha reenviado el PIN de verificación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si no hay una verificación pendiente, se ha solicitado</span>
<span class="sd">                             un reenvío recientemente, o hay otros errores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
                <span class="p">)</span>

        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
        <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

        <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la verificación de doble factor de autenticación&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_pin</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación en dos pasos reenviado con éxito.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_two_factor_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico con el PIN de verificación en dos pasos reenviado.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">            pin (str): PIN de verificación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Reenvío de PIN de verificación en dos pasos - AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">                &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la verificación de dos pasos se solicitó recientemente.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto de verificación de dos pasos.</span>
<span class="sd">            minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última verificación de dos pasos del usuario.</span>

<span class="sd">        Esta función también elimina todas las verificaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            verification (TwoStepVerification): Objeto o lista de objetos de verificación de dos pasos.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[TwoStepVerification]: La última verificación de dos pasos, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
            <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_verification</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de Resend2faUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de Resend2faUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.get_last_verification" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última verificación de dos pasos del usuario.</p>
<p>Esta función también elimina todas las verificaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de verificación de dos pasos.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[TwoStepVerification]: La última verificación de dos pasos, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_verification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TwoStepVerification</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última verificación de dos pasos del usuario.</span>

<span class="sd">    Esta función también elimina todas las verificaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto o lista de objetos de verificación de dos pasos.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[TwoStepVerification]: La última verificación de dos pasos, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verification</span><span class="p">:</span>
        <span class="n">verification</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_verification</span> <span class="o">=</span> <span class="n">verification</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_verification</span> <span class="ow">in</span> <span class="n">verification</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_two_factor_verification</span><span class="p">(</span><span class="n">old_verification</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_verification</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resend_2fa</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reenvía el PIN de verificación en dos pasos.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita el reenvío.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha reenviado el PIN de verificación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una verificación pendiente, se ha solicitado
             un reenvío recientemente, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía el PIN de verificación en dos pasos.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha reenviado el PIN de verificación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una verificación pendiente, se ha solicitado</span>
<span class="sd">                         un reenvío recientemente, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la verificación de doble factor de autenticación&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_pin</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación en dos pasos reenviado con éxito.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.send_two_factor_pin" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_two_factor_pin</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico con el PIN de verificación en dos pasos reenviado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del destinatario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de verificación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_two_factor_pin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico con el PIN de verificación en dos pasos reenviado.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">        pin (str): PIN de verificación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Reenvío de PIN de verificación en dos pasos - AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">            &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de verificación en dos pasos es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.was_recently_requested" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la verificación de dos pasos se solicitó recientemente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>verification</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.TwoStepVerification" href="../models/#app.user.infrastructure.orm_models.TwoStepVerification">TwoStepVerification</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de verificación de dos pasos.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>minutes</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de minutos para considerar una solicitud reciente. Por defecto es 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la solicitud fue reciente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verification</span><span class="p">:</span> <span class="n">TwoStepVerification</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la verificación de dos pasos se solicitó recientemente.</span>

<span class="sd">    Args:</span>
<span class="sd">        verification (TwoStepVerification): Objeto de verificación de dos pasos.</span>
<span class="sd">        minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">verification</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de reenvío del PIN de verificación en dos pasos, incluyendo la validación del estado del usuario, la verificación de solicitudes recientes, y la generación y envío de un nuevo PIN.</p>
<h4 id="metodos-principales-de-reenvio-de-pin-de-verificacion-en-dos-pasos">Métodos Principales de reenvío de PIN de verificación en dos pasos</h4>
<h5 id="resend_2fa">resend_2fa</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.login_process.resend_2fa_use_case.Resend2faUseCase.resend_2fa"></a>
    <div class="doc doc-contents first">

        <p>Reenvía el PIN de verificación en dos pasos.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita el reenvío.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha reenviado el PIN de verificación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una verificación pendiente, se ha solicitado
             un reenvío recientemente, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\login_process\resend_2fa_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_2fa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía el PIN de verificación en dos pasos.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha reenviado el PIN de verificación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una verificación pendiente, se ha solicitado</span>
<span class="sd">                         un reenvío recientemente, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_two_factor_verification</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">verification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_verification</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">verificacion_dos_pasos</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">verification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay una verificación de doble factor de autenticación pendiente para reenviar el PIN.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">verification</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de autenticación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># minutos</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">verification</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">expiration_datetime</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">verification</span><span class="o">.</span><span class="n">created_at</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_two_factor_verification</span><span class="p">(</span><span class="n">verification</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la verificación de doble factor de autenticación&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_two_factor_pin</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de verificación en dos pasos reenviado con éxito.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="proceso-de-recuperacion-de-contrasena">Proceso de Recuperación de Contraseña</h2>
<h3 id="caso-de-uso-recuperacion-de-contrasena">Caso de Uso: Recuperación de Contraseña</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para el proceso de recuperación de contraseña.</p>
<p>Esta clase maneja el proceso de recuperación de contraseña, incluyendo la generación
y envío de PIN, validación del estado del usuario y gestión de solicitudes recientes.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PasswordRecoveryUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para el proceso de recuperación de contraseña.</span>

<span class="sd">    Esta clase maneja el proceso de recuperación de contraseña, incluyendo la generación</span>
<span class="sd">    y envío de PIN, validación del estado del usuario y gestión de solicitudes recientes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de PasswordRecoveryUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">recovery_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicia el proceso de recuperación de contraseña para un usuario.</span>

<span class="sd">        Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">        un PIN, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario que solicita la recuperación.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que se ha enviado el PIN de recuperación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si se ha solicitado un PIN recientemente o hay otros errores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recovery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

        <span class="n">recovery</span> <span class="o">=</span> <span class="n">PasswordRecovery</span><span class="p">(</span>
            <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
            <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
            <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha enviado un PIN de recuperación a tu correo electrónico.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_password_recovery_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico con el PIN de recuperación de contraseña.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">            pin (str): PIN de recuperación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Recuperación de contraseña - AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;&lt;strong&gt;Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>

        <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la recuperación de contraseña se solicitó recientemente.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>
<span class="sd">            minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">        Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_recovery</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de PasswordRecoveryUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de PasswordRecoveryUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.get_last_password_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última recuperación de contraseña del usuario.</p>
<p>Esta función también elimina todas las recuperaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">    Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_recovery</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">recovery_password</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicia el proceso de recuperación de contraseña para un usuario.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un PIN, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita la recuperación.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha enviado el PIN de recuperación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si se ha solicitado un PIN recientemente o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recovery_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicia el proceso de recuperación de contraseña para un usuario.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un PIN, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita la recuperación.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha enviado el PIN de recuperación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si se ha solicitado un PIN recientemente o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recovery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="n">PasswordRecovery</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha enviado un PIN de recuperación a tu correo electrónico.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.send_password_recovery_email" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_password_recovery_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico con el PIN de recuperación de contraseña.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del destinatario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de recuperación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_password_recovery_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico con el PIN de recuperación de contraseña.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">        pin (str): PIN de recuperación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Recuperación de contraseña - AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&lt;html&gt;&lt;body&gt;&lt;p&gt;&lt;strong&gt;Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;&lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>

    <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.was_recently_requested" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la recuperación de contraseña se solicitó recientemente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>minutes</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de minutos para considerar una solicitud reciente. Por defecto es 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la solicitud fue reciente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la recuperación de contraseña se solicitó recientemente.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>
<span class="sd">        minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de recuperación de contraseña, incluyendo la generación y envío de PIN, validación del estado del usuario y gestión de solicitudes recientes.</p>
<h4 id="metodos-principales-de-recuperacion-de-contrasena">Métodos Principales de recuperación de contraseña</h4>
<h5 id="recovery_password">recovery_password</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.password_recovery_process.password_recovery_use_case.PasswordRecoveryUseCase.recovery_password"></a>
    <div class="doc doc-contents first">

        <p>Inicia el proceso de recuperación de contraseña para un usuario.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un PIN, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita la recuperación.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha enviado el PIN de recuperación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si se ha solicitado un PIN recientemente o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\password_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">recovery_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicia el proceso de recuperación de contraseña para un usuario.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un PIN, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita la recuperación.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha enviado el PIN de recuperación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si se ha solicitado un PIN recientemente o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recovery</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">expiration_time</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">expiration_datetime</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">expiration_time</span><span class="p">)</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="n">PasswordRecovery</span><span class="p">(</span>
        <span class="n">usuario_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="n">pin</span><span class="o">=</span><span class="n">pin_hash</span><span class="p">,</span>
        <span class="n">expiracion</span><span class="o">=</span><span class="n">expiration_datetime</span><span class="p">,</span>
        <span class="n">resends</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">created_at</span><span class="o">=</span><span class="n">datetime_utc_time</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">add_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha enviado un PIN de recuperación a tu correo electrónico.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-confirmacion-de-pin-de-recuperacion">Caso de Uso: Confirmación de PIN de Recuperación</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para confirmar el PIN de recuperación de contraseña.</p>
<p>Esta clase maneja el proceso de confirmación del PIN de recuperación,
incluyendo la validación del estado del usuario, la verificación del PIN,
y el manejo de intentos fallidos.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ConfirmRecoveryPinUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para confirmar el PIN de recuperación de contraseña.</span>

<span class="sd">    Esta clase maneja el proceso de confirmación del PIN de recuperación,</span>
<span class="sd">    incluyendo la validación del estado del usuario, la verificación del PIN,</span>
<span class="sd">    y el manejo de intentos fallidos.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de ConfirmRecoveryPinUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">confirm_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confirma el PIN de recuperación de contraseña.</span>

<span class="sd">        Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">        de recuperación de contraseña válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">        los intentos fallidos.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            pin (str): PIN de recuperación proporcionado por el usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que el PIN se confirmó correctamente.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si no hay una solicitud de recuperación válida, el PIN ha expirado,</span>
<span class="sd">                             el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">            UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_password_recovery_expired</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La recuperación de contraseña ha expirado. Por favor, inicie el proceso de recuperación de contraseña nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

        <span class="n">recovery_pin</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span> 

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery_pin</span><span class="p">:</span>
            <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación incorrecto.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación confirmado correctamente.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_password_recovery_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la recuperación de contraseña ha expirado.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la recuperación ha expirado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">recovery</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">        Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_recovery</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si el usuario está bloqueado.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): Objeto de usuario a verificar.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bloquea al usuario por un período de tiempo específico.</span>

<span class="sd">        Args:</span>
<span class="sd">            user (User): Usuario a bloquear.</span>
<span class="sd">            lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se pudo bloquear al usuario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
            <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene el estado de usuario bloqueado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se pudo obtener el estado de usuario bloqueado.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de ConfirmRecoveryPinUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de ConfirmRecoveryPinUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.block_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Bloquea al usuario por un período de tiempo específico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usuario a bloquear.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lock_duration</code></td>
            <td>
                  <code><span title="datetime.timedelta">timedelta</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Duración del bloqueo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario fue bloqueado exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo bloquear al usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">block_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">lock_duration</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bloquea al usuario por un período de tiempo específico.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): Usuario a bloquear.</span>
<span class="sd">        lock_duration (timedelta): Duración del bloqueo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario fue bloqueado exitosamente, False en caso contrario.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo bloquear al usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">lock_duration</span>
        <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar el estado del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo bloquear el usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error al bloquear el usuario: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">confirm_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Confirma el PIN de recuperación de contraseña.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de recuperación de contraseña válida, comprueba el PIN proporcionado y maneja
los intentos fallidos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de recuperación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que el PIN se confirmó correctamente.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una solicitud de recuperación válida, el PIN ha expirado,
             el PIN es incorrecto, o hay otros errores.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">confirm_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Confirma el PIN de recuperación de contraseña.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de recuperación de contraseña válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">    los intentos fallidos.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de recuperación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que el PIN se confirmó correctamente.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una solicitud de recuperación válida, el PIN ha expirado,</span>
<span class="sd">                         el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_password_recovery_expired</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La recuperación de contraseña ha expirado. Por favor, inicie el proceso de recuperación de contraseña nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

    <span class="n">recovery_pin</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery_pin</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación confirmado correctamente.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_last_password_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última recuperación de contraseña del usuario.</p>
<p>Esta función también elimina todas las recuperaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">    Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_recovery</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.get_locked_user_state" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_locked_user_state</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene el estado de usuario bloqueado.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.UserState" href="../models/#app.user.infrastructure.orm_models.UserState">UserState</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo obtener el estado de usuario bloqueado.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_locked_user_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UserStateModel</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene el estado de usuario bloqueado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[UserStateModel]: El estado de usuario bloqueado, o None si no se encuentra.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo obtener el estado de usuario bloqueado.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">locked_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_name</span><span class="p">(</span><span class="n">LOCKED_STATE_NAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">locked_state</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo obtener el estado de usuario bloqueado.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">locked_state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_password_recovery_expired" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_password_recovery_expired</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la recuperación de contraseña ha expirado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la recuperación ha expirado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_password_recovery_expired</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la recuperación de contraseña ha expirado.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la recuperación ha expirado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">recovery</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">&lt;</span> <span class="n">datetime_utc_time</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.is_user_blocked" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_user_blocked</span><span class="p">(</span><span class="n">user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si el usuario está bloqueado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de usuario a verificar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el usuario está bloqueado, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_user_blocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si el usuario está bloqueado.</span>

<span class="sd">    Args:</span>
<span class="sd">        user (User): Objeto de usuario a verificar.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el usuario está bloqueado, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">user</span><span class="o">.</span><span class="n">locked_until</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">state_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locked_user_state</span><span class="p">()</span><span class="o">.</span><span class="n">id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de confirmación del PIN de recuperación, incluyendo la validación del estado del usuario, la verificación del PIN, y el manejo de intentos fallidos.</p>
<h4 id="metodos-principales-de-confirmacion-de-pin-de-recuperacion">Métodos Principales de confirmación de PIN de recuperación</h4>
<h5 id="confirm_recovery">confirm_recovery</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.password_recovery_process.confirm_recovery_use_case.ConfirmRecoveryPinUseCase.confirm_recovery"></a>
    <div class="doc doc-contents first">

        <p>Confirma el PIN de recuperación de contraseña.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de recuperación de contraseña válida, comprueba el PIN proporcionado y maneja
los intentos fallidos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de recuperación proporcionado por el usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que el PIN se confirmó correctamente.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una solicitud de recuperación válida, el PIN ha expirado,
             el PIN es incorrecto, o hay otros errores.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserHasBeenBlockedException">UserHasBeenBlockedException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\confirm_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">confirm_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Confirma el PIN de recuperación de contraseña.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de recuperación de contraseña válida, comprueba el PIN proporcionado y maneja</span>
<span class="sd">    los intentos fallidos.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        pin (str): PIN de recuperación proporcionado por el usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que el PIN se confirmó correctamente.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una solicitud de recuperación válida, el PIN ha expirado,</span>
<span class="sd">                         el PIN es incorrecto, o hay otros errores.</span>
<span class="sd">        UserHasBeenBlockedException: Si el usuario ha sido bloqueado debido a múltiples intentos fallidos.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_password_recovery_expired</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;La recuperación de contraseña ha expirado. Por favor, inicie el proceso de recuperación de contraseña nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">hash_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

    <span class="n">recovery_pin</span> <span class="o">=</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">==</span> <span class="n">pin_hash</span> 

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery_pin</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">block_time</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">block_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">block_time</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">UserHasBeenBlockedException</span><span class="p">(</span><span class="n">block_time</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación incorrecto.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;PIN de recuperación confirmado correctamente.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-reenvio-de-pin-de-recuperacion">Caso de Uso: Reenvío de PIN de Recuperación</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para reenviar el PIN de recuperación de contraseña.</p>
<p>Esta clase maneja el proceso de reenvío del PIN de recuperación, incluyendo
la validación del estado del usuario, la verificación de solicitudes recientes,
y la generación y envío de un nuevo PIN.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResendRecoveryUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para reenviar el PIN de recuperación de contraseña.</span>

<span class="sd">    Esta clase maneja el proceso de reenvío del PIN de recuperación, incluyendo</span>
<span class="sd">    la validación del estado del usuario, la verificación de solicitudes recientes,</span>
<span class="sd">    y la generación y envío de un nuevo PIN.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de ResendRecoveryUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resend_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reenvía el PIN de recuperación de contraseña.</span>

<span class="sd">        Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">        un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">            background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que se ha reenviado el PIN de recuperación.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si no hay un registro de recuperación pendiente, se ha solicitado</span>
<span class="sd">                             un reenvío recientemente, o hay otros errores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                    <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
                <span class="p">)</span>

        <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

        <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

        <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha reenviado el PIN de recuperación a tu correo electrónico.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_password_recovery_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Envía un correo electrónico con el PIN de recuperación de contraseña reenviado.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">            pin (str): PIN de recuperación generado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Reenvío: Recuperación de contraseña - AgroInSight&quot;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">                &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifica si la recuperación de contraseña se solicitó recientemente.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>
<span class="sd">            minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">        Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_recovery</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de ResendRecoveryUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de ResendRecoveryUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.get_last_password_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última recuperación de contraseña del usuario.</p>
<p>Esta función también elimina todas las recuperaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">    Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_recovery</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resend_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Reenvía el PIN de recuperación de contraseña.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita el reenvío.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha reenviado el PIN de recuperación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay un registro de recuperación pendiente, se ha solicitado
             un reenvío recientemente, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía el PIN de recuperación de contraseña.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha reenviado el PIN de recuperación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay un registro de recuperación pendiente, se ha solicitado</span>
<span class="sd">                         un reenvío recientemente, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha reenviado el PIN de recuperación a tu correo electrónico.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.send_password_recovery_email" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">send_password_recovery_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Envía un correo electrónico con el PIN de recuperación de contraseña reenviado.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dirección de correo electrónico del destinatario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pin</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PIN de recuperación generado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el correo se envió exitosamente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">send_password_recovery_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pin</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Envía un correo electrónico con el PIN de recuperación de contraseña reenviado.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Dirección de correo electrónico del destinatario.</span>
<span class="sd">        pin (str): PIN de recuperación generado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el correo se envió exitosamente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;Reenvío: Recuperación de contraseña - AgroInSight&quot;</span>
    <span class="n">text_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Reenvío: Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="se">\n</span><span class="s2">Este PIN expirará en 10 minutos.&quot;</span>
    <span class="n">html_content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    &lt;html&gt;</span>
<span class="s2">        &lt;body&gt;</span>
<span class="s2">            &lt;p&gt;&lt;strong&gt;Reenvío: Tu PIN de recuperación de contraseña es: </span><span class="si">{</span><span class="n">pin</span><span class="si">}</span><span class="s2">&lt;/strong&gt;&lt;/p&gt;</span>
<span class="s2">            &lt;p&gt;Este PIN expirará en 10 minutos.&lt;/p&gt;</span>
<span class="s2">        &lt;/body&gt;</span>
<span class="s2">    &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">send_email</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">html_content</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.was_recently_requested" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Verifica si la recuperación de contraseña se solicitó recientemente.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>minutes</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Número de minutos para considerar una solicitud reciente. Por defecto es 3.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si la solicitud fue reciente, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">was_recently_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifica si la recuperación de contraseña se solicitó recientemente.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto de recuperación de contraseña.</span>
<span class="sd">        minutes (int, optional): Número de minutos para considerar una solicitud reciente. Por defecto es 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si la solicitud fue reciente, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">-</span> <span class="n">ensure_utc</span><span class="p">(</span><span class="n">recovery</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de reenvío del PIN de recuperación, incluyendo la validación del estado del usuario, la verificación de solicitudes recientes, y la generación y envío de un nuevo PIN.</p>
<h4 id="metodos-principales-de-reenvio-de-pin-de-recuperacion">Métodos Principales de reenvío de PIN de recuperación</h4>
<h5 id="resend_recovery">resend_recovery</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.password_recovery_process.resend_recovery_use_case.ResendRecoveryUseCase.resend_recovery"></a>
    <div class="doc doc-contents first">

        <p>Reenvía el PIN de recuperación de contraseña.</p>
<p>Este método valida el estado del usuario, verifica si se ha solicitado recientemente
un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario que solicita el reenvío.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>background_tasks</code></td>
            <td>
                  <code><span title="fastapi.BackgroundTasks">BackgroundTasks</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tareas en segundo plano para enviar el correo.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que se ha reenviado el PIN de recuperación.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay un registro de recuperación pendiente, se ha solicitado
             un reenvío recientemente, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\resend_recovery_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">resend_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">background_tasks</span><span class="p">:</span> <span class="n">BackgroundTasks</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reenvía el PIN de recuperación de contraseña.</span>

<span class="sd">    Este método valida el estado del usuario, verifica si se ha solicitado recientemente</span>
<span class="sd">    un reenvío, genera un nuevo PIN y lo envía por correo electrónico.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario que solicita el reenvío.</span>
<span class="sd">        background_tasks (BackgroundTasks): Tareas en segundo plano para enviar el correo.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que se ha reenviado el PIN de recuperación.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay un registro de recuperación pendiente, se ha solicitado</span>
<span class="sd">                         un reenvío recientemente, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="n">warning_time</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_recently_requested</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="n">warning_time</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Ya has solicitado un PIN de recuperación recientemente. Por favor, espera </span><span class="si">{</span><span class="n">warning_time</span><span class="si">}</span><span class="s2"> minutos antes de solicitar uno nuevo.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_429_TOO_MANY_REQUESTS</span>
            <span class="p">)</span>

    <span class="n">pin</span><span class="p">,</span> <span class="n">pin_hash</span> <span class="o">=</span> <span class="n">generate_pin</span><span class="p">()</span>

    <span class="n">background_tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_password_recovery_email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span>

    <span class="n">recovery</span><span class="o">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin_hash</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">expiracion</span> <span class="o">=</span> <span class="n">datetime_utc_time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">intentos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">recovery</span><span class="o">.</span><span class="n">resends</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Se ha reenviado el PIN de recuperación a tu correo electrónico.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-restablecimiento-de-contrasena">Caso de Uso: Restablecimiento de Contraseña</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para restablecer la contraseña de un usuario.</p>
<p>Esta clase maneja el proceso de restablecimiento de contraseña, incluyendo
la validación del estado del usuario, la verificación del PIN de recuperación,
y la actualización de la contraseña en la base de datos.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.state_validator">state_validator</span></code></td>
            <td>
                  <code><span title="app.user.domain.user_state_validator.UserStateValidator">UserStateValidator</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Validador del estado del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\password_recovery_process\reset_password_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">ResetPasswordUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para restablecer la contraseña de un usuario.</span>

<span class="sd">    Esta clase maneja el proceso de restablecimiento de contraseña, incluyendo</span>
<span class="sd">    la validación del estado del usuario, la verificación del PIN de recuperación,</span>
<span class="sd">    y la actualización de la contraseña en la base de datos.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">        state_validator (UserStateValidator): Validador del estado del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de ResetPasswordUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restablece la contraseña de un usuario.</span>

<span class="sd">        Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">        de recuperación de contraseña válida, y actualiza la contraseña del usuario.</span>

<span class="sd">        Args:</span>
<span class="sd">            email (str): Correo electrónico del usuario.</span>
<span class="sd">            new_password (str): Nueva contraseña a establecer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que la contraseña se restableció correctamente.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">            DomainException: Si no hay una solicitud de recuperación válida, el PIN no está confirmado,</span>
<span class="sd">                             la nueva contraseña es igual a la anterior, o hay otros errores.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

        <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
            <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">state_validation_result</span>

        <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;El PIN de recuperación no ha sido confirmado.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Asegúrate de que la nueva contraseña sea diferente de la anterior&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
            <span class="p">)</span>

        <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la contraseña del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo eliminar el registro de recuperación de contraseña.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span> <span class="s2">&quot;Contraseña restablecida correctamente.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">        Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">        Args:</span>
<span class="sd">            recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
            <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
            <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">latest_recovery</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de ResetPasswordUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\reset_password_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de ResetPasswordUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span> <span class="o">=</span> <span class="n">UserStateValidator</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.get_last_password_recovery" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la última recuperación de contraseña del usuario.</p>
<p>Esta función también elimina todas las recuperaciones anteriores a la última.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>recovery</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Objeto o lista de objetos de recuperación de contraseña.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.PasswordRecovery" href="../models/#app.user.infrastructure.orm_models.PasswordRecovery">PasswordRecovery</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\reset_password_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_last_password_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recovery</span><span class="p">:</span> <span class="n">PasswordRecovery</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PasswordRecovery</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la última recuperación de contraseña del usuario.</span>

<span class="sd">    Esta función también elimina todas las recuperaciones anteriores a la última.</span>

<span class="sd">    Args:</span>
<span class="sd">        recovery (PasswordRecovery): Objeto o lista de objetos de recuperación de contraseña.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[PasswordRecovery]: La última recuperación de contraseña, o None si no hay ninguna.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recovery</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="n">recovery</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span>
        <span class="n">latest_recovery</span> <span class="o">=</span> <span class="n">recovery</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">old_recovery</span> <span class="ow">in</span> <span class="n">recovery</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">old_recovery</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">latest_recovery</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">reset_password</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Restablece la contraseña de un usuario.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de recuperación de contraseña válida, y actualiza la contraseña del usuario.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>new_password</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nueva contraseña a establecer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que la contraseña se restableció correctamente.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una solicitud de recuperación válida, el PIN no está confirmado,
             la nueva contraseña es igual a la anterior, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\reset_password_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restablece la contraseña de un usuario.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de recuperación de contraseña válida, y actualiza la contraseña del usuario.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        new_password (str): Nueva contraseña a establecer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que la contraseña se restableció correctamente.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una solicitud de recuperación válida, el PIN no está confirmado,</span>
<span class="sd">                         la nueva contraseña es igual a la anterior, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;El PIN de recuperación no ha sido confirmado.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Asegúrate de que la nueva contraseña sea diferente de la anterior&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la contraseña del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo eliminar el registro de recuperación de contraseña.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span> <span class="s2">&quot;Contraseña restablecida correctamente.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de restablecimiento de contraseña, incluyendo la validación del estado del usuario, la verificación del PIN de recuperación, y la actualización de la contraseña en la base de datos.</p>
<h4 id="metodos-principales-de-restablecimiento-de-contrasena">Métodos Principales de restablecimiento de contraseña</h4>
<h5 id="reset_password">reset_password</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.password_recovery_process.reset_password_use_case.ResetPasswordUseCase.reset_password"></a>
    <div class="doc doc-contents first">

        <p>Restablece la contraseña de un usuario.</p>
<p>Este método valida el estado del usuario, verifica la existencia de una solicitud
de recuperación de contraseña válida, y actualiza la contraseña del usuario.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>email</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Correo electrónico del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>new_password</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Nueva contraseña a establecer.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que la contraseña se restableció correctamente.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserNotRegisteredException">UserNotRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el usuario no está registrado.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no hay una solicitud de recuperación válida, el PIN no está confirmado,
             la nueva contraseña es igual a la anterior, o hay otros errores.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\password_recovery_process\reset_password_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Restablece la contraseña de un usuario.</span>

<span class="sd">    Este método valida el estado del usuario, verifica la existencia de una solicitud</span>
<span class="sd">    de recuperación de contraseña válida, y actualiza la contraseña del usuario.</span>

<span class="sd">    Args:</span>
<span class="sd">        email (str): Correo electrónico del usuario.</span>
<span class="sd">        new_password (str): Nueva contraseña a establecer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que la contraseña se restableció correctamente.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserNotRegisteredException: Si el usuario no está registrado.</span>
<span class="sd">        DomainException: Si no hay una solicitud de recuperación válida, el PIN no está confirmado,</span>
<span class="sd">                         la nueva contraseña es igual a la anterior, o hay otros errores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_with_password_recovery</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserNotRegisteredException</span><span class="p">()</span>

    <span class="n">state_validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_validator</span><span class="o">.</span><span class="n">validate_user_state</span><span class="p">(</span>
        <span class="n">user</span><span class="p">,</span>
        <span class="n">allowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">ACTIVE</span><span class="p">],</span>
        <span class="n">disallowed_states</span><span class="o">=</span><span class="p">[</span><span class="n">UserState</span><span class="o">.</span><span class="n">INACTIVE</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">PENDING</span><span class="p">,</span> <span class="n">UserState</span><span class="o">.</span><span class="n">LOCKED</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">state_validation_result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state_validation_result</span>

    <span class="n">recovery</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_last_password_recovery</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">recuperacion_contrasena</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No hay un registro de recuperación de contraseña pendiente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_404_NOT_FOUND</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">recovery</span><span class="o">.</span><span class="n">pin_confirmado</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;El PIN de recuperación no ha sido confirmado.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">verify_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Asegúrate de que la nueva contraseña sea diferente de la anterior&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>
        <span class="p">)</span>

    <span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">new_password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la contraseña del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">delete_password_recovery</span><span class="p">(</span><span class="n">recovery</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo eliminar el registro de recuperación de contraseña.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span> <span class="s2">&quot;Contraseña restablecida correctamente.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="otros-casos-de-uso">Otros Casos de Uso</h2>
<h3 id="caso-de-uso-cierre-de-sesion">Caso de Uso: Cierre de Sesión</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.logout_use_case.LogoutUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para gestionar el cierre de sesión de un usuario.</p>
<p>Esta clase maneja el proceso de cerrar sesión, incluyendo la inclusión
del token en la lista negra.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.logout_use_case.LogoutUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\logout_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">LogoutUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para gestionar el cierre de sesión de un usuario.</span>

<span class="sd">    Esta clase maneja el proceso de cerrar sesión, incluyendo la inclusión</span>
<span class="sd">    del token en la lista negra.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de LogoutUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Realiza el proceso de cierre de sesión para un usuario.</span>

<span class="sd">        Este método intenta incluir el token en la lista negra y devuelve una respuesta</span>
<span class="sd">        de éxito si se logra, o lanza una excepción si falla.</span>

<span class="sd">        Args:</span>
<span class="sd">            token (str): Token de autenticación a incluir en la lista negra.</span>
<span class="sd">            user_id (int): ID del usuario que está cerrando sesión.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que el cierre de sesión fue exitoso.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DomainException: Si no se pudo cerrar la sesión.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo cerrar la sesión. Intenta nuevamente.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sesión cerrada exitosamente.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">blacklist_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Incluye un token en la lista negra.</span>

<span class="sd">        Args:</span>
<span class="sd">            token (str): Token de autenticación a incluir en la lista negra.</span>
<span class="sd">            user_id (int): ID del usuario asociado al token.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True si el token se incluyó exitosamente en la lista negra, False en caso contrario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blacklisted</span> <span class="o">=</span> <span class="n">BlacklistedToken</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">usuario_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">blacklist_token</span><span class="p">(</span><span class="n">blacklisted</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.logout_use_case.LogoutUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de LogoutUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\logout_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de LogoutUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.logout_use_case.LogoutUseCase.blacklist_token" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">blacklist_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Incluye un token en la lista negra.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>token</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token de autenticación a incluir en la lista negra.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>user_id</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID del usuario asociado al token.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>bool</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True si el token se incluyó exitosamente en la lista negra, False en caso contrario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\logout_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">blacklist_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Incluye un token en la lista negra.</span>

<span class="sd">    Args:</span>
<span class="sd">        token (str): Token de autenticación a incluir en la lista negra.</span>
<span class="sd">        user_id (int): ID del usuario asociado al token.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True si el token se incluyó exitosamente en la lista negra, False en caso contrario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">blacklisted</span> <span class="o">=</span> <span class="n">BlacklistedToken</span><span class="p">(</span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span> <span class="n">usuario_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">blacklist_token</span><span class="p">(</span><span class="n">blacklisted</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.logout_use_case.LogoutUseCase.logout" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">logout</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Realiza el proceso de cierre de sesión para un usuario.</p>
<p>Este método intenta incluir el token en la lista negra y devuelve una respuesta
de éxito si se logra, o lanza una excepción si falla.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>token</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token de autenticación a incluir en la lista negra.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>user_id</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID del usuario que está cerrando sesión.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que el cierre de sesión fue exitoso.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo cerrar la sesión.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\logout_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza el proceso de cierre de sesión para un usuario.</span>

<span class="sd">    Este método intenta incluir el token en la lista negra y devuelve una respuesta</span>
<span class="sd">    de éxito si se logra, o lanza una excepción si falla.</span>

<span class="sd">    Args:</span>
<span class="sd">        token (str): Token de autenticación a incluir en la lista negra.</span>
<span class="sd">        user_id (int): ID del usuario que está cerrando sesión.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que el cierre de sesión fue exitoso.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo cerrar la sesión.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo cerrar la sesión. Intenta nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sesión cerrada exitosamente.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de cerrar sesión, incluyendo la inclusión del token en la lista negra.</p>
<h4 id="metodos-principales-de-cierre-de-sesion">Métodos Principales de cierre de sesión</h4>
<h5 id="logout">logout</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.logout_use_case.LogoutUseCase.logout"></a>
    <div class="doc doc-contents first">

        <p>Realiza el proceso de cierre de sesión para un usuario.</p>
<p>Este método intenta incluir el token en la lista negra y devuelve una respuesta
de éxito si se logra, o lanza una excepción si falla.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>token</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Token de autenticación a incluir en la lista negra.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>user_id</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID del usuario que está cerrando sesión.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que el cierre de sesión fue exitoso.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo cerrar la sesión.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\logout_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza el proceso de cierre de sesión para un usuario.</span>

<span class="sd">    Este método intenta incluir el token en la lista negra y devuelve una respuesta</span>
<span class="sd">    de éxito si se logra, o lanza una excepción si falla.</span>

<span class="sd">    Args:</span>
<span class="sd">        token (str): Token de autenticación a incluir en la lista negra.</span>
<span class="sd">        user_id (int): ID del usuario que está cerrando sesión.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que el cierre de sesión fue exitoso.</span>

<span class="sd">    Raises:</span>
<span class="sd">        DomainException: Si no se pudo cerrar la sesión.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blacklist_token</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo cerrar la sesión. Intenta nuevamente.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sesión cerrada exitosamente.&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-obtener-usuario-actual">Caso de Uso: Obtener Usuario Actual</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.get_current_user_use_case.GetCurrentUserUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para obtener la información del usuario actual.</p>
<p>Esta clase maneja la lógica para recuperar y validar la información del usuario actual.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.get_current_user_use_case.GetCurrentUserUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos para realizar operaciones.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.get_current_user_use_case.GetCurrentUserUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones de usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\get_current_user_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">GetCurrentUserUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para obtener la información del usuario actual.</span>

<span class="sd">    Esta clase maneja la lógica para recuperar y validar la información del usuario actual.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): La sesión de base de datos para realizar operaciones.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones de usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de GetCurrentUserUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserInDB</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtiene la información del usuario actual.</span>

<span class="sd">        Este método verifica la existencia del usuario actual y su estado,</span>
<span class="sd">        y devuelve la información del usuario mapeada a la respuesta adecuada.</span>

<span class="sd">        Args:</span>
<span class="sd">            current_user (UserInDB): El usuario actual autenticado.</span>

<span class="sd">        Returns:</span>
<span class="sd">            UserResponse: La información del usuario mapeada a la respuesta.</span>

<span class="sd">        Raises:</span>
<span class="sd">            MissingTokenException: Si no se proporciona un usuario actual.</span>
<span class="sd">            UserStateException: Si el estado del usuario no es reconocido.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MissingTokenException</span><span class="p">()</span>

        <span class="c1"># Obtener el estado del usuario</span>
        <span class="n">estado</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_id</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">state_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">estado</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Estado de usuario no reconocido.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
            <span class="p">)</span>

        <span class="n">current_user</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">estado</span>
        <span class="k">return</span> <span class="n">map_user_to_response</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.get_current_user_use_case.GetCurrentUserUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de GetCurrentUserUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La sesión de base de datos a utilizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\get_current_user_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de GetCurrentUserUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): La sesión de base de datos a utilizar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_current_user</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Obtiene la información del usuario actual.</p>
<p>Este método verifica la existencia del usuario actual y su estado,
y devuelve la información del usuario mapeada a la respuesta adecuada.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>current_user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserInDB" href="../schemas/#app.user.domain.schemas.UserInDB">UserInDB</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El usuario actual autenticado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>UserResponse</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserResponse" href="../schemas/#app.user.domain.schemas.UserResponse">UserResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La información del usuario mapeada a la respuesta.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.MissingTokenException">MissingTokenException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se proporciona un usuario actual.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es reconocido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\get_current_user_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserInDB</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la información del usuario actual.</span>

<span class="sd">    Este método verifica la existencia del usuario actual y su estado,</span>
<span class="sd">    y devuelve la información del usuario mapeada a la respuesta adecuada.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_user (UserInDB): El usuario actual autenticado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        UserResponse: La información del usuario mapeada a la respuesta.</span>

<span class="sd">    Raises:</span>
<span class="sd">        MissingTokenException: Si no se proporciona un usuario actual.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es reconocido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingTokenException</span><span class="p">()</span>

    <span class="c1"># Obtener el estado del usuario</span>
    <span class="n">estado</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_id</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">state_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">estado</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Estado de usuario no reconocido.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>

    <span class="n">current_user</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">estado</span>
    <span class="k">return</span> <span class="n">map_user_to_response</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja la lógica para recuperar y validar la información del usuario actual.</p>
<h4 id="metodos-principales-de-obtener-usuario-actual">Métodos Principales de obtener usuario actual</h4>
<h5 id="get_current_user">get_current_user</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.get_current_user_use_case.GetCurrentUserUseCase.get_current_user"></a>
    <div class="doc doc-contents first">

        <p>Obtiene la información del usuario actual.</p>
<p>Este método verifica la existencia del usuario actual y su estado,
y devuelve la información del usuario mapeada a la respuesta adecuada.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>current_user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserInDB" href="../schemas/#app.user.domain.schemas.UserInDB">UserInDB</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>El usuario actual autenticado.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>UserResponse</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserResponse" href="../schemas/#app.user.domain.schemas.UserResponse">UserResponse</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>La información del usuario mapeada a la respuesta.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.MissingTokenException">MissingTokenException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se proporciona un usuario actual.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserStateException">UserStateException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el estado del usuario no es reconocido.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\get_current_user_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">UserInDB</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtiene la información del usuario actual.</span>

<span class="sd">    Este método verifica la existencia del usuario actual y su estado,</span>
<span class="sd">    y devuelve la información del usuario mapeada a la respuesta adecuada.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_user (UserInDB): El usuario actual autenticado.</span>

<span class="sd">    Returns:</span>
<span class="sd">        UserResponse: La información del usuario mapeada a la respuesta.</span>

<span class="sd">    Raises:</span>
<span class="sd">        MissingTokenException: Si no se proporciona un usuario actual.</span>
<span class="sd">        UserStateException: Si el estado del usuario no es reconocido.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MissingTokenException</span><span class="p">()</span>

    <span class="c1"># Obtener el estado del usuario</span>
    <span class="n">estado</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_state_by_id</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">state_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">estado</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UserStateException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Estado de usuario no reconocido.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">user_state</span><span class="o">=</span><span class="s2">&quot;unknown&quot;</span>
        <span class="p">)</span>

    <span class="n">current_user</span><span class="o">.</span><span class="n">estado</span> <span class="o">=</span> <span class="n">estado</span>
    <span class="k">return</span> <span class="n">map_user_to_response</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h3 id="caso-de-uso-actualizar-informacion-de-usuario">Caso de Uso: Actualizar Información de Usuario</h3>


<div class="doc doc-object doc-class">



<a id="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase"></a>
    <div class="doc doc-contents first">


        <p>Caso de uso para actualizar la información de un usuario.</p>
<p>Esta clase maneja el proceso de actualización de la información del usuario,
incluyendo la verificación de correo electrónico duplicado.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.db">db</span></code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.user_repository">user_repository</span></code></td>
            <td>
                  <code><span title="app.user.infrastructure.sql_repository.UserRepository">UserRepository</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Repositorio para operaciones relacionadas con usuarios.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>app\user\application\update_user_info_use_case.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">UpdateUserInfoUseCase</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Caso de uso para actualizar la información de un usuario.</span>

<span class="sd">    Esta clase maneja el proceso de actualización de la información del usuario,</span>
<span class="sd">    incluyendo la verificación de correo electrónico duplicado.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        user_repository (UserRepository): Repositorio para operaciones relacionadas con usuarios.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inicializa una nueva instancia de UpdateUserInfoUseCase.</span>

<span class="sd">        Args:</span>
<span class="sd">            db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">user_update</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Actualiza la información del usuario.</span>

<span class="sd">        Este método verifica si el nuevo correo electrónico ya está en uso,</span>
<span class="sd">        actualiza la información del usuario y guarda los cambios en la base de datos.</span>

<span class="sd">        Args:</span>
<span class="sd">            current_user (User): Usuario actual cuya información se va a actualizar.</span>
<span class="sd">            user_update (UserUpdate): Datos actualizados del usuario.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SuccessResponse: Respuesta indicando que la actualización fue exitosa.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserAlreadyRegisteredException: Si el nuevo correo electrónico ya está en uso por otro usuario.</span>
<span class="sd">            DomainException: Si no se pudo actualizar la información del usuario.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Verificar si el email ya está en uso por otro usuario</span>
        <span class="k">if</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span> <span class="o">!=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_update</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserAlreadyRegisteredException</span><span class="p">()</span>

            <span class="n">current_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span>

        <span class="n">current_user</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">nombre</span>
        <span class="n">current_user</span><span class="o">.</span><span class="n">apellido</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">apellido</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">current_user</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la información del usuario.&quot;</span><span class="p">,</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario actualizado exitosamente&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Inicializa una nueva instancia de UpdateUserInfoUseCase.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>db</code></td>
            <td>
                  <code><span title="sqlalchemy.orm.Session">Session</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sesión de base de datos para operaciones de persistencia.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\update_user_info_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inicializa una nueva instancia de UpdateUserInfoUseCase.</span>

<span class="sd">    Args:</span>
<span class="sd">        db (Session): Sesión de base de datos para operaciones de persistencia.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span> <span class="o">=</span> <span class="n">UserRepository</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_user_info</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">user_update</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Actualiza la información del usuario.</p>
<p>Este método verifica si el nuevo correo electrónico ya está en uso,
actualiza la información del usuario y guarda los cambios en la base de datos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>current_user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usuario actual cuya información se va a actualizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>user_update</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserUpdate" href="../schemas/#app.user.domain.schemas.UserUpdate">UserUpdate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datos actualizados del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que la actualización fue exitosa.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserAlreadyRegisteredException">UserAlreadyRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el nuevo correo electrónico ya está en uso por otro usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo actualizar la información del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\update_user_info_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">user_update</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actualiza la información del usuario.</span>

<span class="sd">    Este método verifica si el nuevo correo electrónico ya está en uso,</span>
<span class="sd">    actualiza la información del usuario y guarda los cambios en la base de datos.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_user (User): Usuario actual cuya información se va a actualizar.</span>
<span class="sd">        user_update (UserUpdate): Datos actualizados del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que la actualización fue exitosa.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserAlreadyRegisteredException: Si el nuevo correo electrónico ya está en uso por otro usuario.</span>
<span class="sd">        DomainException: Si no se pudo actualizar la información del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar si el email ya está en uso por otro usuario</span>
    <span class="k">if</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span> <span class="o">!=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_update</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserAlreadyRegisteredException</span><span class="p">()</span>

        <span class="n">current_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span>

    <span class="n">current_user</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">nombre</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">apellido</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">apellido</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">current_user</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la información del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario actualizado exitosamente&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p>Este caso de uso maneja el proceso de actualización de la información del usuario, incluyendo la verificación de correo electrónico duplicado.</p>
<h4 id="metodos-principales-de-actualizacion-de-informacion-de-usuario">Métodos Principales de actualización de información de usuario</h4>
<h5 id="update_user_info">update_user_info</h5>


<div class="doc doc-object doc-function">



<a id="app.user.application.update_user_info_use_case.UpdateUserInfoUseCase.update_user_info"></a>
    <div class="doc doc-contents first">

        <p>Actualiza la información del usuario.</p>
<p>Este método verifica si el nuevo correo electrónico ya está en uso,
actualiza la información del usuario y guarda los cambios en la base de datos.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>current_user</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.infrastructure.orm_models.User" href="../models/#app.user.infrastructure.orm_models.User">User</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Usuario actual cuya información se va a actualizar.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>user_update</code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="app.user.domain.schemas.UserUpdate" href="../schemas/#app.user.domain.schemas.UserUpdate">UserUpdate</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Datos actualizados del usuario.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>SuccessResponse</code></td>            <td>
                  <code><span title="app.infrastructure.common.response_models.SuccessResponse">SuccessResponse</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Respuesta indicando que la actualización fue exitosa.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.UserAlreadyRegisteredException">UserAlreadyRegisteredException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si el nuevo correo electrónico ya está en uso por otro usuario.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="app.infrastructure.common.common_exceptions.DomainException">DomainException</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Si no se pudo actualizar la información del usuario.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>app\user\application\update_user_info_use_case.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">user_update</span><span class="p">:</span> <span class="n">UserUpdate</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SuccessResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Actualiza la información del usuario.</span>

<span class="sd">    Este método verifica si el nuevo correo electrónico ya está en uso,</span>
<span class="sd">    actualiza la información del usuario y guarda los cambios en la base de datos.</span>

<span class="sd">    Args:</span>
<span class="sd">        current_user (User): Usuario actual cuya información se va a actualizar.</span>
<span class="sd">        user_update (UserUpdate): Datos actualizados del usuario.</span>

<span class="sd">    Returns:</span>
<span class="sd">        SuccessResponse: Respuesta indicando que la actualización fue exitosa.</span>

<span class="sd">    Raises:</span>
<span class="sd">        UserAlreadyRegisteredException: Si el nuevo correo electrónico ya está en uso por otro usuario.</span>
<span class="sd">        DomainException: Si no se pudo actualizar la información del usuario.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Verificar si el email ya está en uso por otro usuario</span>
    <span class="k">if</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span> <span class="o">!=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">get_user_by_email</span><span class="p">(</span><span class="n">user_update</span><span class="o">.</span><span class="n">email</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserAlreadyRegisteredException</span><span class="p">()</span>

        <span class="n">current_user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">email</span>

    <span class="n">current_user</span><span class="o">.</span><span class="n">nombre</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">nombre</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">apellido</span> <span class="o">=</span> <span class="n">user_update</span><span class="o">.</span><span class="n">apellido</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_repository</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">current_user</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">DomainException</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;No se pudo actualizar la información del usuario.&quot;</span><span class="p">,</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">SuccessResponse</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s2">&quot;Usuario actualizado exitosamente&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>